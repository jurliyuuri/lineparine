<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ãƒ•ã‚¡ã‚¤ã‚¯ãƒ¬ã‚ªãƒæš¦ãƒ„ãƒ¼ãƒ«</title>

    <style>
        /* ===== å…±é€šãƒˆãƒ¼ã‚¯ãƒ³ ===== */
        :root {
            --bg: #0b0c10;
            --panel: #12141b;
            --panel2: #171a23;
            --text: #e8eaf0;
            --muted: #a8afc3;
            --line: #24283a;
            --accent: #7aa2f7;
            --warn: #f7768e;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
            background: linear-gradient(180deg, var(--bg), #07080c);
            color: var(--text);
            min-height: 100vh;
        }

        header {
            padding: 16px;
            border-bottom: 1px solid var(--line);
            background: rgba(18, 20, 27, 0.85);
            position: sticky;
            top: 0;
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .header-top {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }

        .app-title {
            font-weight: 900;
            font-size: 18px;
            letter-spacing: 0.3px;
        }

        /* ===== ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ ===== */
        .tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .tab-btn {
            background: var(--panel2);
            border: 1px solid var(--line);
            color: var(--muted);
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: var(--panel);
            color: var(--text);
        }

        .tab-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #0b0c10;
        }

        /* ===== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ===== */
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 14px;
        }

        label {
            font-size: 12px;
            color: var(--muted);
        }

        input[type="number"],
        select {
            background: var(--panel2);
            border: 1px solid var(--line);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 10px;
            outline: none;
            min-width: 140px;
        }

        button {
            background: var(--accent);
            border: 0;
            color: #0b0c10;
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
        }

        button:active {
            transform: translateY(1px);
        }

        /* ===== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ===== */
        main {
            padding: 18px 16px 40px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ãƒ”ãƒ« ===== */
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(122, 162, 247, 0.14);
            border: 1px solid rgba(122, 162, 247, 0.28);
            color: var(--text);
            font-size: 12px;
        }

        .pill.warn {
            background: rgba(247, 118, 142, 0.12);
            border-color: rgba(247, 118, 142, 0.25);
        }

        .note {
            margin-top: 14px;
            color: var(--muted);
            font-size: 13px;
            line-height: 1.6;
            max-width: 1100px;
        }

        code {
            background: rgba(255, 255, 255, 0.06);
            padding: 2px 6px;
            border-radius: 8px;
        }

        /* ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ ===== */
        .year-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(280px, 1fr));
            gap: 14px;
            margin-top: 14px;
        }

        @media (max-width: 1100px) {
            .year-grid {
                grid-template-columns: repeat(2, minmax(280px, 1fr));
            }
        }

        @media (max-width: 720px) {
            .year-grid {
                grid-template-columns: 1fr;
            }
        }

        .month-card {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 28px rgba(0, 0, 0, 0.35);
            min-height: 320px;
        }

        .month-head {
            padding: 12px 12px 10px;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            border-bottom: 1px solid var(--line);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), transparent);
        }

        .month-title {
            font-weight: 800;
            letter-spacing: 0.3px;
        }

        .month-sub {
            color: var(--muted);
            font-size: 12px;
        }

        .month-title .leap-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 999px;
            margin-left: 8px;
            background: rgba(247, 118, 142, 0.12);
            border: 1px solid rgba(247, 118, 142, 0.25);
            color: var(--text);
            font-weight: 800;
            letter-spacing: .2px;
        }

        /* ãƒ•ã‚£ãƒ¼ã‚¯æš¦ï¼š6åˆ— */
        .fiik-dow,
        .fiik-days {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
        }

        .fiik-days div:nth-child(6n) {
            border-right: 0;
        }

        /* ãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦ï¼š7åˆ— */
        .phil-dow,
        .phil-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }

        .phil-days div:nth-child(7n) {
            border-right: 0;
        }

        /* ä¿®æ­£ãƒªãƒ‘ãƒ©ã‚ªãƒæš¦ï¼š5åˆ— */
        .ripa-dow,
        .ripa-days {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
        }

        .ripa-days div:nth-child(5n) {
            border-right: 0;
        }

        .ripa-days .leapday {
            background: rgba(247, 118, 142, 0.12);
            border-color: rgba(247, 118, 142, 0.25);
            font-weight: 800;
            position: relative;
        }

        .ripa-days .leapday::after {
            content: "é–";
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 10px;
            color: var(--muted);
        }

        .ripa-days .newmoon {
            outline: 2px solid rgba(247, 118, 142, 0.55);
            outline-offset: -2px;
            box-shadow: 0 0 0 3px rgba(247, 118, 142, 0.12) inset;
        }

        .ripa-days .fullmoon {
            outline: 2px solid rgba(122, 162, 247, 0.65);
            outline-offset: -2px;
            box-shadow: 0 0 0 3px rgba(122, 162, 247, 0.12) inset;
        }

        .fiik-dow div,
        .phil-dow div,
        .ripa-dow div {
            padding: 8px 6px;
            text-align: center;
            font-size: 12px;
            color: var(--muted);
            border-bottom: 1px solid var(--line);
            background: rgba(255, 255, 255, 0.02);
            white-space: nowrap;
        }

        .fiik-days div,
        .phil-days div,
        .ripa-days div {
            height: 36px;
            display: grid;
            place-items: center;
            border-bottom: 1px solid var(--line);
            border-right: 1px solid var(--line);
            font-size: 13px;
            background: rgba(255, 255, 255, 0.02);
        }

        .fiik-days .empty,
        .phil-days .empty,
        .ripa-days .empty {
            background: rgba(255, 255, 255, 0.01);
            color: transparent;
        }

        .fiik-days .day,
        .phil-days .day,
        .ripa-days .day {
            position: relative;
        }

        .moonmark {
            position: absolute;
            top: 3px;
            left: 4px;
            font-size: 12px;
            line-height: 1;
            font-family: system-ui, "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
            opacity: .9;
        }

        .fiik-days .newmoon,
        .phil-days .newmoon {
            outline: 2px solid rgba(247, 118, 142, 0.55);
            outline-offset: -2px;
            box-shadow: 0 0 0 3px rgba(247, 118, 142, 0.12) inset;
        }

        .fiik-days .fullmoon,
        .phil-days .fullmoon {
            outline: 2px solid rgba(122, 162, 247, 0.65);
            outline-offset: -2px;
            box-shadow: 0 0 0 3px rgba(122, 162, 247, 0.12) inset;
        }

        .phil-days .leapday {
            background: rgba(247, 118, 142, 0.12);
            border-color: rgba(247, 118, 142, 0.25);
            font-weight: 800;
            position: relative;
        }

        .phil-days .leapday::after {
            content: "é–";
            position: absolute;
            top: 4px;
            right: 6px;
            font-size: 10px;
            color: var(--muted);
        }

        /* ===== å¤‰æ›ãƒ„ãƒ¼ãƒ« ===== */
        .converter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-top: 14px;
        }

        @media (max-width: 900px) {
            .converter-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--line);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 28px rgba(0, 0, 0, 0.35);
        }

        .card h2 {
            margin: 0;
            padding: 12px 12px 10px;
            font-size: 14px;
            font-weight: 900;
            border-bottom: 1px solid var(--line);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), transparent);
        }

        .card .body {
            padding: 12px;
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: end;
        }

        .out {
            margin-top: 10px;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid var(--line);
            background: rgba(255, 255, 255, 0.03);
        }

        .out .k {
            color: var(--muted);
            font-size: 12px;
        }

        .out .v {
            font-size: 14px;
            margin-top: 6px;
            line-height: 1.5;
        }

        .err {
            color: var(--warn);
        }

        details {
            margin-top: 10px;
        }

        details summary {
            cursor: pointer;
            color: var(--muted);
            font-size: 12px;
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        }
    </style>
</head>

<body>
    <header>
        <div class="header-top">
            <div class="app-title">ãƒ•ã‚¡ã‚¤ã‚¯ãƒ¬ã‚ªãƒæš¦ãƒ„ãƒ¼ãƒ«</div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="phil-calendar">ãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
            <button class="tab-btn" data-tab="ripa-calendar">ä¿®æ­£ãƒªãƒ‘ãƒ©ã‚ªãƒæš¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
            <button class="tab-btn" data-tab="fiik-calendar">ãƒ•ã‚£ãƒ¼ã‚¯æš¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
            <button class="tab-btn" data-tab="converter">æš¦å¤‰æ›</button>
        </div>
    </header>

    <main>
        <!-- ===== ãƒ•ã‚£ãƒ¼ã‚¯æš¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ===== -->
        <div id="fiik-calendar" class="tab-content">
            <div class="controls">
                <div>
                    <label for="fiik-year">å¹´</label><br />
                    <input id="fiik-year" type="number" step="1" value="1" />
                </div>
                <div>
                    <label for="fiik-view">è¡¨ç¤º</label><br />
                    <select id="fiik-view">
                        <option value="year" selected>å¹´ï¼ˆ12ãƒ¶æœˆï¼‰</option>
                        <option value="month">æœˆï¼ˆ1ã¤ã ã‘ï¼‰</option>
                    </select>
                </div>
                <div>
                    <label for="fiik-month">æœˆ</label><br />
                    <select id="fiik-month"></select>
                </div>
                <div style="align-self:end;">
                    <button id="fiik-render">ç”Ÿæˆ</button>
                </div>
            </div>
            <div id="fiik-status" class="note"></div>
            <div id="fiik-calendar-grid"></div>
        </div>

        <!-- ===== ãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ===== -->
        <div id="phil-calendar" class="tab-content active">
            <div class="controls">
                <div>
                    <label for="phil-year">å¹´</label><br />
                    <input id="phil-year" type="number" step="1" value="0" />
                </div>
                <div>
                    <label for="phil-view">è¡¨ç¤º</label><br />
                    <select id="phil-view">
                        <option value="year" selected>å¹´ï¼ˆ12ãƒ¶æœˆï¼‰</option>
                        <option value="month">æœˆï¼ˆ1ã¤ã ã‘ï¼‰</option>
                    </select>
                </div>
                <div>
                    <label for="phil-month">æœˆ</label><br />
                    <select id="phil-month"></select>
                </div>
                <div style="align-self:end;">
                    <button id="phil-render">ç”Ÿæˆ</button>
                </div>
            </div>
            <div id="phil-status" class="note"></div>
            <div id="phil-calendar-grid"></div>
        </div>

        <!-- ===== ä¿®æ­£ãƒªãƒ‘ãƒ©ã‚ªãƒæš¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ===== -->
        <div id="ripa-calendar" class="tab-content">
            <div class="controls">
                <div>
                    <label for="ripa-year">å¹´</label><br />
                    <input id="ripa-year" type="number" step="1" value="0" />
                </div>
                <div>
                    <label for="ripa-view">è¡¨ç¤º</label><br />
                    <select id="ripa-view">
                        <option value="year" selected>å¹´ï¼ˆ12ãƒ¶æœˆï¼‰</option>
                        <option value="month">æœˆï¼ˆ1ã¤ã ã‘ï¼‰</option>
                    </select>
                </div>
                <div>
                    <label for="ripa-month">æœˆ</label><br />
                    <select id="ripa-month"></select>
                </div>
                <div style="align-self:end;">
                    <button id="ripa-render">ç”Ÿæˆ</button>
                </div>
            </div>
            <div id="ripa-status" class="note"></div>
            <div id="ripa-calendar-grid"></div>
        </div>

        <!-- ===== æš¦å¤‰æ› ===== -->
        <div id="converter" class="tab-content">
            <p class="note" style="margin-top:0; margin-bottom:14px;">ã„ãšã‚Œã‹ã®æš¦ã§æ—¥ä»˜ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ä»–ã®2ã¤ã®æš¦ã®æ—¥ä»˜ãŒè‡ªå‹•çš„ã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚</p>

            <div class="converter-grid" style="grid-template-columns: repeat(3, 1fr);">
                <!-- ãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦å…¥åŠ› -->
                <section class="card">
                    <h2>ãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦</h2>
                    <div class="body">
                        <div class="row">
                            <div>
                                <label for="pY">å¹´</label><br>
                                <input id="pY" type="number" step="1" value="0" style="min-width:100px;">
                            </div>
                            <div>
                                <label for="pM">æœˆ</label><br>
                                <input id="pM" type="number" step="1" min="1" max="12" value="1"
                                    style="min-width:60px;">
                            </div>
                            <div>
                                <label for="pD">æ—¥</label><br>
                                <input id="pD" type="number" step="1" min="1" value="1" style="min-width:60px;">
                            </div>
                        </div>
                        <div id="philStatus" class="note" style="margin-top:8px;"></div>
                    </div>
                </section>

                <!-- ä¿®æ­£ãƒªãƒ‘ãƒ©ã‚ªãƒæš¦å…¥åŠ› -->
                <section class="card">
                    <h2>ä¿®æ­£ãƒªãƒ‘ãƒ©ã‚ªãƒæš¦</h2>
                    <div class="body">
                        <div class="row">
                            <div>
                                <label for="rY">å¹´</label><br>
                                <input id="rY" type="number" step="1" value="0" style="min-width:100px;">
                            </div>
                            <div>
                                <label for="rM">æœˆ</label><br>
                                <input id="rM" type="number" step="1" min="1" max="12" value="1"
                                    style="min-width:60px;">
                            </div>
                            <div>
                                <label for="rD">æ—¥</label><br>
                                <input id="rD" type="number" step="1" min="1" value="1" style="min-width:60px;">
                            </div>
                        </div>
                        <div id="ripaStatus" class="note" style="margin-top:8px;"></div>
                    </div>
                </section>

                <!-- ãƒ•ã‚£ãƒ¼ã‚¯æš¦å…¥åŠ› -->
                <section class="card">
                    <h2>ãƒ•ã‚£ãƒ¼ã‚¯æš¦</h2>
                    <div class="body">
                        <div class="row">
                            <div>
                                <label for="fY">å¹´</label><br>
                                <input id="fY" type="number" step="1" value="1" style="min-width:100px;">
                            </div>
                            <div>
                                <label for="fM">æœˆ</label><br>
                                <input id="fM" type="number" step="1" min="1" max="13" value="1"
                                    style="min-width:60px;">
                            </div>
                            <div>
                                <label for="fD">æ—¥</label><br>
                                <input id="fD" type="number" step="1" min="1" value="1" style="min-width:60px;">
                            </div>
                        </div>
                        <div id="fiikStatus" class="note" style="margin-top:8px;"></div>
                    </div>
                </section>
            </div>

            <!-- æœˆé½¢è¡¨ç¤ºï¼ˆå…±é€šï¼‰ -->
            <div class="out"
                style="margin-top:14px; background: rgba(122, 162, 247, 0.08); border-color: rgba(122, 162, 247, 0.2);">
                <div class="k">æœˆé½¢</div>
                <div class="v mono" id="outLunar">â€”</div>
            </div>

            <details style="margin-top:14px">
                <summary>å®Ÿè£…ãƒ¡ãƒ¢ï¼ˆã‚¢ãƒ³ã‚«ãƒ¼å®šæ•°ï¼‰</summary>
                <div class="out" style="margin-top:8px">
                    <div class="k">æš¦é–“ã®å¯¾å¿œé–¢ä¿‚</div>
                    <div class="v mono" id="anchorView">â€”</div>
                </div>
            </details>
        </div>
    </main>

    <script>
        // ========================================
        // å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        // ========================================
        function mod(n, m) { return ((n % m) + m) % m; }
        function sum(arr) { return arr.reduce((a, b) => a + b, 0); }
        function intOrNaN(v) { const n = Number(v); return Number.isFinite(n) ? Math.trunc(n) : NaN; }

        // ========================================
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        // ========================================
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        // ========================================
        // æœˆç›¸ï¼ˆå…±é€šï¼‰
        // ========================================
        const SYNODIC_MONTH = 29.5660340294;
        // æœˆç›¸å: ã€Œæœ”ã€ã€Œæœ›ã€ã¯æœ¬å½“ã®æ–°æœˆãƒ»æº€æœˆã®ã¿ã«ä½¿ç”¨
        const PHASES = [
            { name: "æ–°æœˆ", mark: "ğŸŒ‘", exactName: "æœ”" },
            { name: "ä¸‰æ—¥æœˆ", mark: "ğŸŒ’", exactName: "ä¸‰æ—¥æœˆ" },
            { name: "ä¸Šå¼¦", mark: "ğŸŒ“", exactName: "ä¸Šå¼¦" },
            { name: "åä¸‰å¤œ", mark: "ğŸŒ”", exactName: "åä¸‰å¤œ" },
            { name: "æº€æœˆ", mark: "ğŸŒ•", exactName: "æœ›" },
            { name: "åå…­å¤œ", mark: "ğŸŒ–", exactName: "åå…­å¤œ" },
            { name: "ä¸‹å¼¦", mark: "ğŸŒ—", exactName: "ä¸‹å¼¦" },
            { name: "äºŒåå…­å¤œ", mark: "ğŸŒ˜", exactName: "äºŒåå…­å¤œ" },
        ];
        const MOON_EPS = 1e-6;

        // isExact: æœ¬å½“ã®æ–°æœˆ/æº€æœˆã®å ´åˆã«true
        function phaseForAge(age, isExact = false) {
            // å„æœˆç›¸ã®ã€Œä¸­å¿ƒã€ã‚’åŸºæº–ã«ã™ã‚‹ãŸã‚ã€æœ”æœ›æœˆ/16ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¿½åŠ 
            // ã“ã‚Œã«ã‚ˆã‚Šã€æ–°æœˆï¼ˆğŸŒ‘ï¼‰ã¯æœˆé½¢0ã‚’ä¸­å¿ƒã¨ã—ãŸå‰å¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹
            const offset = SYNODIC_MONTH / 16;
            const idx = Math.floor(mod(age + offset, SYNODIC_MONTH) / SYNODIC_MONTH * 8) % 8;
            const phase = PHASES[idx];
            if (isExact && (idx === 0 || idx === 4)) {
                return { name: phase.exactName, mark: phase.mark };
            }
            return { name: phase.name, mark: phase.mark };
        }

        // ========================================
        // ãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦
        // ========================================
        const PHIL_MONTHS = [
            { name: "ãƒ¬ãƒŠ", days: 31 },
            { name: "ãƒ•ãƒ¥ãƒ¼ã‚¢", days: 30 },
            { name: "ãƒ¦ã‚¹ãƒ„ã‚¡ãƒ—ãƒ­ãƒ¼ã‚µ", days: 30 },
            { name: "ã‚±ã‚¤ãƒ³ãƒ†ãƒ«", days: 31 },
            { name: "ã‚·ãƒ¥ãƒˆã‚¥ãƒ¼ã‚¬", days: 30 },
            { name: "ã‚·ãƒ¥ãƒ„ã‚¡ãƒ¼", days: 30 },
            { name: "ãƒ¦ãƒ³ã‚«ãƒ¼", days: 31 },
            { name: "ãƒ¦ãƒŠãƒ•ãƒ©", days: 30 },
            { name: "ã‚·ã‚§ãƒ¼ã‚¿ãƒ¼", days: 30 },
            { name: "ãƒ•ã‚£ãƒ¬ãƒŠ", days: 31 },
            { name: "ãƒ´ã‚§ãƒ«ã‚¬ãƒŠ", days: 30 },
            { name: "ãƒ«ãƒãƒ¼", days: 31 }
        ];

        const PHIL_DOW = ["æœˆæ›œæ—¥", "ç«æ›œæ—¥", "æ°´æ›œæ—¥", "æœ¨æ›œæ—¥", "é‡‘æ›œæ—¥", "åœŸæ›œæ—¥", "æ—¥æ›œæ—¥"];
        const PHIL_SPECIAL_LEAP_POS = new Set([250, 750, 1250]);
        const PHIL_CYCLE_YEARS = 2000;
        const PHIL_LEAPS_PER_CYCLE = 503;
        const PHIL_CYCLE_DAYS = PHIL_CYCLE_YEARS * 365 + PHIL_LEAPS_PER_CYCLE;

        // ãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦ã®æœˆé½¢åŸºæº–
        const PHIL_NEW_MOON_REF = { year: 0, month: 1, day: 2 };
        let PHIL_NEW_MOON_EPOCH_DAY = null;

        function phil_cycleInfo(y) {
            const q = Math.floor((y - 1) / PHIL_CYCLE_YEARS);
            const pos = mod((y - 1), PHIL_CYCLE_YEARS) + 1;
            return { q, pos };
        }

        function phil_isLeapYear(y) {
            const { pos } = phil_cycleInfo(y);
            return (pos % 4 === 0) || PHIL_SPECIAL_LEAP_POS.has(pos);
        }

        function phil_prefixLeapsInCycle(n) {
            if (n <= 0) return 0;
            let c = Math.floor(n / 4);
            if (n >= 250) c += 1;
            if (n >= 750) c += 1;
            if (n >= 1250) c += 1;
            return c;
        }

        function phil_offsetWithinCycleToYearStart(pos) {
            const prevYears = pos - 1;
            return prevYears * 365 + phil_prefixLeapsInCycle(prevYears);
        }

        function phil_daysBeforeYear(y) {
            const { q, pos } = phil_cycleInfo(y);
            return q * PHIL_CYCLE_DAYS + phil_offsetWithinCycleToYearStart(pos);
        }

        function phil_daysBeforeMonth(month) {
            let s = 0;
            for (let i = 1; i < month; i++) s += PHIL_MONTHS[i - 1].days;
            return s;
        }

        function phil_monthDaysInYear(year, month) {
            const base = PHIL_MONTHS[month - 1].days;
            return (month === 12 && phil_isLeapYear(year)) ? base + 1 : base;
        }

        function phil_toAbs(y, m, d) {
            if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) throw new Error("å…¥åŠ›ãŒæ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
            if (m < 1 || m > 12) throw new Error("phil æœˆã¯ 1ã€œ12 ã§ã™ã€‚");
            const md = phil_monthDaysInYear(y, m);
            if (d < 1 || d > md) throw new Error(`phil æ—¥ã¯ãã®æœˆã§ã¯ 1ã€œ${md} ã§ã™ã€‚`);
            return phil_daysBeforeYear(y) + phil_daysBeforeMonth(m) + (d - 1);
        }

        function phil_fromAbs(absDay) {
            if (!Number.isFinite(absDay)) throw new Error("absDay ãŒä¸æ­£ã§ã™ã€‚");

            const q = Math.floor(absDay / PHIL_CYCLE_DAYS);
            let rem = absDay - q * PHIL_CYCLE_DAYS;

            const startOfPos = (pos) => phil_offsetWithinCycleToYearStart(pos);
            let lo = 1, hi = PHIL_CYCLE_YEARS + 1;
            while (lo + 1 < hi) {
                const mid = Math.floor((lo + hi) / 2);
                if (startOfPos(mid) <= rem) lo = mid;
                else hi = mid;
            }
            const pos = lo;
            const year = q * PHIL_CYCLE_YEARS + pos;

            let dayOfYear0 = rem - startOfPos(pos);
            let month = 1;
            for (; month <= 12; month++) {
                const len = phil_monthDaysInYear(year, month);
                if (dayOfYear0 < len) break;
                dayOfYear0 -= len;
            }
            const day = dayOfYear0 + 1;
            return { year, month, day };
        }

        function phil_weekdayIndexFromEpoch(totalDaysSinceEpoch) {
            return mod(totalDaysSinceEpoch, 7);
        }

        function phil_initNewMoonEpoch() {
            if (PHIL_NEW_MOON_EPOCH_DAY === null) {
                PHIL_NEW_MOON_EPOCH_DAY =
                    phil_daysBeforeYear(PHIL_NEW_MOON_REF.year) +
                    phil_daysBeforeMonth(PHIL_NEW_MOON_REF.month) +
                    (PHIL_NEW_MOON_REF.day - 1);
            }
        }

        function phil_lunarAgeForAbsoluteDay(absDay) {
            phil_initNewMoonEpoch();
            const delta = absDay - PHIL_NEW_MOON_EPOCH_DAY;
            return mod(delta, SYNODIC_MONTH);
        }

        function phil_dayHasNewMoon(absDay) {
            phil_initNewMoonEpoch();
            const S = SYNODIC_MONTH;
            // æ—¥ã®å§‹ã¾ã‚Šæ™‚ç‚¹ã§ã®æœˆé½¢ï¼ˆè¡¨ç¤ºã•ã‚Œã‚‹æœˆé½¢ã¨åŒã˜ï¼‰
            const age = mod(absDay - PHIL_NEW_MOON_EPOCH_DAY, S);
            // æœˆé½¢ãŒ0ã«æœ€ã‚‚è¿‘ã„æ—¥ï¼ˆÂ±0.5æ—¥ä»¥å†…ï¼‰ã‚’æœ”ã¨ã™ã‚‹
            return age <= 0.5 || age > S - 0.5;
        }

        function phil_dayHasFullMoon(absDay) {
            phil_initNewMoonEpoch();
            const S = SYNODIC_MONTH;
            const halfS = S / 2;
            // æ—¥ã®å§‹ã¾ã‚Šæ™‚ç‚¹ã§ã®æœˆé½¢ï¼ˆè¡¨ç¤ºã•ã‚Œã‚‹æœˆé½¢ã¨åŒã˜ï¼‰
            const age = mod(absDay - PHIL_NEW_MOON_EPOCH_DAY, S);
            // æœˆé½¢ãŒæœ”æœ›æœˆã®åŠåˆ†ï¼ˆæº€æœˆï¼‰ã«æœ€ã‚‚è¿‘ã„æ—¥ï¼ˆÂ±0.5æ—¥ä»¥å†…ï¼‰ã‚’æœ›ã¨ã™ã‚‹
            return Math.abs(age - halfS) <= 0.5;
        }

        // ========================================
        // ãƒ•ã‚£ãƒ¼ã‚¯æš¦
        // ========================================
        const FIIK_LEAP_POS = new Set([3, 6, 8, 11, 14, 17]);
        const FIIK_YEAR_CYCLE = 17;

        const FIIK_COMMON_MONTH_DAYS = [30, 29, 30, 29, 30, 29, 30, 29, 30, 29, 30, 30];
        const FIIK_LEAP_MONTH_DAYS = [30, 29, 30, 29, 30, 29, 30, 29, 30, 29, 30, 29, 30];
        const FIIK_COMMON_YEAR_DAYS = sum(FIIK_COMMON_MONTH_DAYS);
        const FIIK_LEAP_YEAR_DAYS = sum(FIIK_LEAP_MONTH_DAYS);

        const FIIK_CYCLE_YEAR_DAYS = Array.from({ length: FIIK_YEAR_CYCLE }, (_, i) => {
            const r = i + 1;
            return FIIK_LEAP_POS.has(r) ? FIIK_LEAP_YEAR_DAYS : FIIK_COMMON_YEAR_DAYS;
        });
        const FIIK_CYCLE_DAYS_TOTAL = sum(FIIK_CYCLE_YEAR_DAYS);

        const FIIK_WEEK_LEN = 6;
        const FIIK_DOW = ["ä¸€æ›œæ—¥", "äºŒæ›œæ—¥", "ä¸‰æ›œæ—¥", "å››æ›œæ—¥", "äº”æ›œæ—¥", "å…­æ›œæ—¥"];
        const FIIK_EPOCH_DOW0 = 0;
        const FIIK_EPOCH_LUNAR_AGE = 0.6860292012;

        function fiik_civilToAstroYear(yCivil) {
            if (!Number.isFinite(yCivil)) throw new Error("fiik å¹´ãŒä¸æ­£ã§ã™ã€‚");
            if (yCivil === 0) throw new Error("fiik ã«ã¯ 0å¹´ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆâ€¦, -2å¹´, -1å¹´, 1å¹´, 2å¹´, â€¦ï¼‰ã€‚");
            return (yCivil > 0) ? yCivil : (yCivil + 1);
        }

        function fiik_astroToCivilYear(yAstro) {
            return (yAstro > 0) ? yAstro : (yAstro - 1);
        }

        function fiik_yearInfoAstro(yAstro) {
            const r = mod((yAstro - 1), FIIK_YEAR_CYCLE) + 1;
            const isLeap = FIIK_LEAP_POS.has(r);
            const monthDays = isLeap ? FIIK_LEAP_MONTH_DAYS : FIIK_COMMON_MONTH_DAYS;
            return { yAstro, yearInCycle: r, isLeap, monthDays, monthsCount: monthDays.length, yearDays: isLeap ? FIIK_LEAP_YEAR_DAYS : FIIK_COMMON_YEAR_DAYS };
        }

        function fiik_getYearInfo(Y) {
            const y = Math.trunc(Number(Y) || 1);
            const cycleIndex = Math.floor((y - 1) / FIIK_YEAR_CYCLE);
            const r = mod((y - 1), FIIK_YEAR_CYCLE) + 1;
            const isLeap = FIIK_LEAP_POS.has(r);
            const monthDays = isLeap ? FIIK_LEAP_MONTH_DAYS.slice() : FIIK_COMMON_MONTH_DAYS.slice();
            return {
                y,
                cycleIndex,
                yearInCycle: r,
                isLeap,
                monthDays,
                monthsCount: monthDays.length,
                yearDays: isLeap ? FIIK_LEAP_YEAR_DAYS : FIIK_COMMON_YEAR_DAYS
            };
        }

        function fiik_daysSinceEpoch(year, monthIndex0, day) {
            const y = Math.trunc(Number(year) || 1);
            const m = Math.max(0, Math.trunc(Number(monthIndex0) || 0));
            const d = Math.max(1, Math.trunc(Number(day) || 1));

            const yearsBefore = y - 1;
            const fullCycles = Math.floor(yearsBefore / FIIK_YEAR_CYCLE);
            const within = mod(yearsBefore, FIIK_YEAR_CYCLE);

            let total = fullCycles * FIIK_CYCLE_DAYS_TOTAL;
            for (let i = 0; i < within; i++) total += FIIK_CYCLE_YEAR_DAYS[i];

            const yi = fiik_getYearInfo(y);
            for (let i = 0; i < m; i++) total += yi.monthDays[i];

            total += (d - 1);
            return total;
        }

        function fiik_weekdayIndex(year, monthIndex0, day) {
            const t = fiik_daysSinceEpoch(year, monthIndex0, day);
            return mod(FIIK_EPOCH_DOW0 + mod(t, FIIK_WEEK_LEN), FIIK_WEEK_LEN);
        }

        function fiik_lunarAgeAtAbsDay(absDay) {
            return mod(FIIK_EPOCH_LUNAR_AGE + absDay, SYNODIC_MONTH);
        }

        function fiik_dayHasNewMoon(absDay) {
            const S = SYNODIC_MONTH;
            const u = FIIK_EPOCH_LUNAR_AGE + absDay;
            const a = Math.floor(u / S);
            const b = Math.floor((u + 1) / S);
            const r = mod(u, S);
            const atBoundary = (r < MOON_EPS) || (S - r < MOON_EPS);
            return (a !== b) || atBoundary;
        }

        function fiik_dayHasFullMoon(absDay) {
            const S = SYNODIC_MONTH;
            const u = (FIIK_EPOCH_LUNAR_AGE + absDay) - (S / 2);
            const a = Math.floor(u / S);
            const b = Math.floor((u + 1) / S);
            const r = mod(u, S);
            const atBoundary = (r < MOON_EPS) || (S - r < MOON_EPS);
            return (a !== b) || atBoundary;
        }

        function fiik_toAbsCivil(yCivil, m1, d) {
            if (!Number.isFinite(m1) || !Number.isFinite(d)) throw new Error("å…¥åŠ›ãŒæ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
            if (m1 < 1 || m1 > 13) throw new Error("fiik æœˆã¯ 1ã€œ13 ã§ã™ï¼ˆ13æœˆã¯é–å¹´ã®ã¿ï¼‰ã€‚");

            const yAstro = fiik_civilToAstroYear(yCivil);
            const info = fiik_yearInfoAstro(yAstro);

            if (m1 > info.monthsCount) throw new Error("ãã®å¹´ã¯é–å¹´ã§ã¯ãªã„ãŸã‚ 13æœˆã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚");
            const m0 = m1 - 1;
            const md = info.monthDays[m0];
            if (d < 1 || d > md) throw new Error(`fiik æ—¥ã¯ãã®æœˆã§ã¯ 1ã€œ${md} ã§ã™ã€‚`);

            const yearsBefore = yAstro - 1;
            const fullCycles = Math.floor(yearsBefore / FIIK_YEAR_CYCLE);
            const within = mod(yearsBefore, FIIK_YEAR_CYCLE);

            let total = fullCycles * FIIK_CYCLE_DAYS_TOTAL;
            for (let i = 0; i < within; i++) total += FIIK_CYCLE_YEAR_DAYS[i];

            for (let i = 0; i < m0; i++) total += info.monthDays[i];
            total += (d - 1);
            return total;
        }

        function fiik_fromAbsToCivil(absDay) {
            if (!Number.isFinite(absDay)) throw new Error("absDay ãŒä¸æ­£ã§ã™ã€‚");

            const fullCycles = Math.floor(absDay / FIIK_CYCLE_DAYS_TOTAL);
            let rem = absDay - fullCycles * FIIK_CYCLE_DAYS_TOTAL;

            let withinIdx = 0;
            while (withinIdx < FIIK_YEAR_CYCLE && rem >= FIIK_CYCLE_YEAR_DAYS[withinIdx]) {
                rem -= FIIK_CYCLE_YEAR_DAYS[withinIdx];
                withinIdx++;
            }
            const yAstro = fullCycles * FIIK_YEAR_CYCLE + withinIdx + 1;

            const info = fiik_yearInfoAstro(yAstro);
            let m0 = 0;
            while (m0 < info.monthsCount && rem >= info.monthDays[m0]) {
                rem -= info.monthDays[m0];
                m0++;
            }
            const month = m0 + 1;
            const day = rem + 1;

            const yCivil = fiik_astroToCivilYear(yAstro);
            return { year: yCivil, month, day, isLeap: info.isLeap, yearAstro: yAstro };
        }

        // ========================================
        // æš¦é–“ã‚¢ãƒ³ã‚«ãƒ¼
        // ========================================
        const ANCHOR_PHIL = { year: 1384, month: 5, day: 10 };
        const PHIL_AT_FIIK_EPOCH = phil_toAbs(ANCHOR_PHIL.year, ANCHOR_PHIL.month, ANCHOR_PHIL.day);

        function philToFiik(y, m, d) {
            const philAbs = phil_toAbs(y, m, d);
            const fiikAbs = philAbs - PHIL_AT_FIIK_EPOCH;
            const fiik = fiik_fromAbsToCivil(fiikAbs);
            return { philAbs, fiikAbs, fiik };
        }

        function fiikToPhil(yCivil, m, d) {
            const fiikAbs = fiik_toAbsCivil(yCivil, m, d);
            const philAbs = fiikAbs + PHIL_AT_FIIK_EPOCH;
            const phil = phil_fromAbs(philAbs);
            return { fiikAbs, philAbs, phil };
        }

        // ========================================
        // ãƒ•ã‚£ãƒ¼ã‚¯æš¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ UI
        // ========================================
        const fiikYearEl = document.getElementById("fiik-year");
        const fiikViewEl = document.getElementById("fiik-view");
        const fiikMonthEl = document.getElementById("fiik-month");
        const fiikStatusEl = document.getElementById("fiik-status");
        const fiikCalEl = document.getElementById("fiik-calendar-grid");

        function fiik_syncMonthOptions() {
            const info = fiik_getYearInfo(fiikYearEl.value);
            const prev = Number(fiikMonthEl.value || 1);

            fiikMonthEl.innerHTML = "";
            for (let i = 1; i <= info.monthsCount; i++) {
                const opt = document.createElement("option");
                opt.value = String(i);
                opt.textContent = (info.isLeap && i === 13) ? "é–13æœˆ" : `${i}æœˆ`;
                fiikMonthEl.appendChild(opt);
            }

            const next = Math.min(info.monthsCount, Math.max(1, prev));
            fiikMonthEl.value = String(next);
            fiikMonthEl.disabled = (fiikViewEl.value !== "month");
        }

        function fiik_buildMonthCard(year, month1) {
            const info = fiik_getYearInfo(year);
            const idx0 = month1 - 1;
            const daysInMonth = info.monthDays[idx0];

            const startAbs = fiik_daysSinceEpoch(info.y, idx0, 1);
            const startW = fiik_weekdayIndex(info.y, idx0, 1);

            const card = document.createElement("div");
            card.className = "month-card";

            const isIntercalary = (info.isLeap && month1 === 13);

            const head = document.createElement("div");
            head.className = "month-head";
            head.innerHTML = `
      <div class="month-title">
        ${isIntercalary ? `13æœˆ <span class="leap-badge">é–</span>` : `${month1}æœˆ`}
      </div>
      <div class="month-sub">${daysInMonth}æ—¥</div>
    `;
            card.appendChild(head);

            const dow = document.createElement("div");
            dow.className = "fiik-dow";
            for (let i = 0; i < FIIK_WEEK_LEN; i++) {
                const d = document.createElement("div");
                d.textContent = FIIK_DOW[i];
                dow.appendChild(d);
            }
            card.appendChild(dow);

            const days = document.createElement("div");
            days.className = "fiik-days";

            for (let i = 0; i < startW; i++) {
                const e = document.createElement("div");
                e.className = "empty";
                e.textContent = ".";
                days.appendChild(e);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const absDay = startAbs + (day - 1);

                const hasNew = fiik_dayHasNewMoon(absDay);
                const hasFull = fiik_dayHasFullMoon(absDay);

                const age = fiik_lunarAgeAtAbsDay(absDay);
                const isExactMoon = hasNew || hasFull;
                const phase = phaseForAge(age, isExactMoon);

                const cell = document.createElement("div");
                let cls = "day";
                if (hasNew) cls += " newmoon";
                if (hasFull) cls += " fullmoon";
                cell.className = cls;

                const moon = document.createElement("span");
                moon.className = "moonmark";
                moon.textContent = hasNew ? "ğŸŒ‘" : (hasFull ? "ğŸŒ•" : phase.mark);

                const num = document.createElement("span");
                num.textContent = String(day);

                cell.appendChild(moon);
                cell.appendChild(num);

                const w = fiik_weekdayIndex(info.y, idx0, day);

                cell.title = `æœˆé½¢ ${age.toFixed(3)}æ—¥ï¼ˆ${phase.name}ï¼‰`;

                days.appendChild(cell);
            }

            const totalCells = startW + daysInMonth;
            const pad = mod((FIIK_WEEK_LEN - mod(totalCells, FIIK_WEEK_LEN)), FIIK_WEEK_LEN);
            for (let i = 0; i < pad; i++) {
                const e = document.createElement("div");
                e.className = "empty";
                e.textContent = ".";
                days.appendChild(e);
            }

            card.appendChild(days);
            return card;
        }

        function fiik_render() {
            const info = fiik_getYearInfo(fiikYearEl.value);
            fiikYearEl.value = String(info.y);

            fiik_syncMonthOptions();

            fiikStatusEl.innerHTML = `
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <span class="pill">å¹´ ${info.y}</span>
        <span class="pill ${info.isLeap ? "warn" : ""}">${info.isLeap ? "é–å¹´" : "å¹³å¹´"}</span>
      </div>
    `;

            fiikCalEl.innerHTML = "";
            const grid = document.createElement("div");
            grid.className = "year-grid";

            if (fiikViewEl.value === "month") {
                grid.style.gridTemplateColumns = "minmax(280px, 520px)";
                const m = Math.min(info.monthsCount, Math.max(1, Math.trunc(Number(fiikMonthEl.value || 1))));
                grid.appendChild(fiik_buildMonthCard(info.y, m));
                fiikCalEl.appendChild(grid);
                return;
            }

            for (let m = 1; m <= info.monthsCount; m++) {
                grid.appendChild(fiik_buildMonthCard(info.y, m));
            }
            fiikCalEl.appendChild(grid);
        }

        document.getElementById("fiik-render").addEventListener("click", fiik_render);
        fiikViewEl.addEventListener("change", () => { fiik_syncMonthOptions(); fiik_render(); });
        fiikYearEl.addEventListener("keydown", (e) => { if (e.key === "Enter") fiik_render(); });
        fiikMonthEl.addEventListener("change", fiik_render);

        // 0å¹´ã‚’é£›ã°ã™å‡¦ç†
        let fiikLastYear = parseInt(fiikYearEl.value) || 1;
        fiikYearEl.addEventListener("input", () => {
            const current = parseInt(fiikYearEl.value);
            if (current === 0) {
                // å‰å›ã®å€¤ã¨æ¯”è¼ƒã—ã¦å¢—æ¸›æ–¹å‘ã‚’åˆ¤å®š
                if (fiikLastYear > 0) {
                    fiikYearEl.value = -1;
                } else {
                    fiikYearEl.value = 1;
                }
            }
            fiikLastYear = parseInt(fiikYearEl.value) || 1;
        });

        // ========================================
        // ãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ UI
        // ========================================
        const philYearEl = document.getElementById("phil-year");
        const philViewEl = document.getElementById("phil-view");
        const philMonthEl = document.getElementById("phil-month");
        const philStatusEl = document.getElementById("phil-status");
        const philCalEl = document.getElementById("phil-calendar-grid");

        // æœˆã‚»ãƒ¬ã‚¯ãƒˆåˆæœŸåŒ–
        PHIL_MONTHS.forEach((m, i) => {
            const opt = document.createElement("option");
            opt.value = String(i + 1);
            opt.textContent = m.name;
            philMonthEl.appendChild(opt);
        });

        function phil_buildMonthCard(year, month) {
            const m = PHIL_MONTHS[month - 1];
            const monthLen = phil_monthDaysInYear(year, month);

            const startDays = phil_daysBeforeYear(year) + phil_daysBeforeMonth(month);
            const startW = phil_weekdayIndexFromEpoch(startDays);

            const card = document.createElement("div");
            card.className = "month-card";

            const head = document.createElement("div");
            head.className = "month-head";
            head.innerHTML = `
      <div class="month-title">${m.name}</div>
      <div class="month-sub">${monthLen}æ—¥</div>
    `;
            card.appendChild(head);

            const dow = document.createElement("div");
            dow.className = "phil-dow";
            for (let i = 0; i < 7; i++) {
                const d = document.createElement("div");
                d.textContent = PHIL_DOW[i];
                dow.appendChild(d);
            }
            card.appendChild(dow);

            const days = document.createElement("div");
            days.className = "phil-days";

            for (let i = 0; i < startW; i++) {
                const e = document.createElement("div");
                e.className = "empty";
                e.textContent = ".";
                days.appendChild(e);
            }

            for (let day = 1; day <= monthLen; day++) {
                const isLeapDayCell = (month === 12 && phil_isLeapYear(year) && day === 32);

                const absDay = startDays + (day - 1);

                const hasNew = phil_dayHasNewMoon(absDay);
                const hasFull = phil_dayHasFullMoon(absDay);

                const age = phil_lunarAgeForAbsoluteDay(absDay);
                const isExactMoon = hasNew || hasFull;
                const phase = phaseForAge(age, isExactMoon);

                const cell = document.createElement("div");
                let cls = isLeapDayCell ? "day leapday" : "day";
                if (hasNew) cls += " newmoon";
                if (hasFull) cls += " fullmoon";
                cell.className = cls;

                const moon = document.createElement("span");
                moon.className = "moonmark";
                moon.textContent = hasNew ? "ğŸŒ‘" : (hasFull ? "ğŸŒ•" : phase.mark);

                const num = document.createElement("span");
                num.textContent = String(day);

                cell.appendChild(moon);
                cell.appendChild(num);

                const ageText = age.toFixed(3);

                const tags = [];
                if (isLeapDayCell) tags.push("é–æ—¥ï¼ˆãƒ«ãƒãƒ¼32æ—¥ï¼‰");

                cell.title = `æœˆé½¢ ${ageText}æ—¥ï¼ˆ${phase.name}ï¼‰` + (tags.length ? ` / ${tags.join("ãƒ»")}` : "");

                days.appendChild(cell);
            }

            const totalCells = startW + monthLen;
            const pad = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < pad; i++) {
                const e = document.createElement("div");
                e.className = "empty";
                e.textContent = ".";
                days.appendChild(e);
            }

            card.appendChild(days);
            return card;
        }

        function phil_render() {
            const yRaw = Number(philYearEl.value);
            const y = Number.isFinite(yRaw) ? Math.trunc(yRaw) : 1;
            philYearEl.value = String(y);

            const view = philViewEl.value;
            const m = Math.min(12, Math.max(1, Math.trunc(Number(philMonthEl.value || 1))));

            const leap = phil_isLeapYear(y);
            const { q, pos } = phil_cycleInfo(y);

            const reasons = [];
            if (pos % 4 === 0) reasons.push("å‘¨æœŸå†…ä½ç½®ãŒ4ã®å€æ•°");
            if (PHIL_SPECIAL_LEAP_POS.has(pos)) reasons.push("å‘¨æœŸå†…ä½ç½®ãŒç‰¹åˆ¥å¹´(250/750/1250)");

            philStatusEl.innerHTML = `
      <div>
        <span class="pill">å¹´ ${y}</span>
        <span class="pill ${leap ? "warn" : ""}">${leap ? "é–å¹´" : "å¹³å¹´"}</span>
        ${leap ? `<span class="pill warn">ç†ç”±ï¼š${reasons.join(" / ")}</span>` : ""}
      </div>
    `;

            philCalEl.innerHTML = "";

            if (view === "month") {
                const wrap = document.createElement("div");
                wrap.className = "year-grid";
                wrap.style.gridTemplateColumns = "minmax(240px, 520px)";
                wrap.appendChild(phil_buildMonthCard(y, m));
                philCalEl.appendChild(wrap);
                return;
            }

            const grid = document.createElement("div");
            grid.className = "year-grid";
            for (let mm = 1; mm <= 12; mm++) {
                grid.appendChild(phil_buildMonthCard(y, mm));
            }
            philCalEl.appendChild(grid);
        }

        function phil_syncUI() {
            philMonthEl.disabled = (philViewEl.value !== "month");
        }

        document.getElementById("phil-render").addEventListener("click", phil_render);
        philViewEl.addEventListener("change", () => { phil_syncUI(); phil_render(); });
        philYearEl.addEventListener("keydown", (e) => { if (e.key === "Enter") phil_render(); });
        philMonthEl.addEventListener("change", phil_render);

        // ========================================
        // ä¿®æ­£ãƒªãƒ‘ãƒ©ã‚ªãƒæš¦
        // ========================================
        const RIPA_MONTHS = [
            { name: "ãƒ¬ãƒŠ", days: 30 },
            { name: "ãƒ•ãƒ¥ãƒ¼ã‚¢", days: 30 },
            { name: "ãƒ¦ã‚¹ãƒ„ã‚¡ãƒ—ãƒ­ãƒ¼ã‚µ", days: 30 },
            { name: "ã‚±ã‚¤ãƒ³ãƒ†ãƒ«", days: 30 },
            { name: "ã‚·ãƒ¥ãƒˆã‚¥ãƒ¼ã‚¬", days: 30 },
            { name: "ã‚·ãƒ¥ãƒ„ã‚¡ãƒ¼", days: 30 },
            { name: "ãƒ¦ãƒ³ã‚«ãƒ¼", days: 30 },
            { name: "ãƒ¦ãƒŠãƒ•ãƒ©", days: 30 },
            { name: "ã‚·ã‚§ãƒ¼ã‚¿ãƒ¼", days: 30 },
            { name: "ãƒ•ã‚£ãƒ¬ãƒŠ", days: 30 },
            { name: "ãƒ´ã‚§ãƒ«ã‚¬ãƒŠ", days: 30 },
            { name: "ãƒ«ãƒãƒ¼", days: 35 }
        ];

        const RIPA_DOW = ["é–‹æ›œæ—¥", "å¼æ›œæ—¥", "ä¸­æ›œæ—¥", "è£æ›œæ—¥", "é–‰æ›œæ—¥"];
        const RIPA_WEEK_LEN = 5;
        const RIPA_YEAR_DAYS = 30 * 11 + 35; // 365

        // ã‚¢ãƒ³ã‚«ãƒ¼ï¼šä¿®æ­£ãƒªãƒ‘ãƒ©ã‚ªãƒæš¦992å¹´1æœˆ3æ—¥ = ãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦2003å¹´2æœˆ25æ—¥
        const RIPA_ANCHOR = { year: 992, month: 1, day: 3 };
        const RIPA_ANCHOR_PHIL = { year: 2003, month: 2, day: 25 };
        const RIPA_ANCHOR_PHIL_ABS = phil_toAbs(RIPA_ANCHOR_PHIL.year, RIPA_ANCHOR_PHIL.month, RIPA_ANCHOR_PHIL.day);

        // é–å¹´åˆ¤å®š: 665å¹´ä»¥é™ã€2000å¹´å‘¨æœŸã§503å›ã®é–å¹´ï¼ˆãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦ã¨åŒã˜ãƒ«ãƒ¼ãƒ«ï¼‰
        const RIPA_LEAP_START_YEAR = 668;
        const RIPA_CYCLE_YEARS = 2000;
        const RIPA_SPECIAL_LEAP_POS = new Set([250, 750, 1250]);

        function ripa_cycleInfo(y) {
            if (y < RIPA_LEAP_START_YEAR) return { q: 0, pos: 0, inCycle: false };
            const offset = y - RIPA_LEAP_START_YEAR;
            const q = Math.floor(offset / RIPA_CYCLE_YEARS);
            const pos = (offset % RIPA_CYCLE_YEARS) + 1;
            return { q, pos, inCycle: true };
        }

        function ripa_isLeapYear(y) {
            if (y < RIPA_LEAP_START_YEAR) return false;
            const { pos } = ripa_cycleInfo(y);
            return (pos % 4 === 0) || RIPA_SPECIAL_LEAP_POS.has(pos);
        }

        // å¹´ã®æ—¥æ•°
        function ripa_yearDays(y) {
            return ripa_isLeapYear(y) ? RIPA_YEAR_DAYS + 1 : RIPA_YEAR_DAYS;
        }

        // å¹´ã®é–å¹´æ•°ã‚’è¨ˆç®—ï¼ˆ2000å¹´å‘¨æœŸå†…ï¼‰
        function ripa_prefixLeapsInCycle(n) {
            if (n <= 0) return 0;
            let c = Math.floor(n / 4);
            if (n >= 250) c += 1;
            if (n >= 750) c += 1;
            if (n >= 1250) c += 1;
            return c;
        }

        // ã‚¢ãƒ³ã‚«ãƒ¼å¹´æœˆæ—¥ã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¨ˆç®—
        const RIPA_ANCHOR_DAY_IN_YEAR = (function () {
            let d = 0;
            for (let i = 1; i < RIPA_ANCHOR.month; i++) d += RIPA_MONTHS[i - 1].days;
            d += RIPA_ANCHOR.day - 1;
            return d;
        })();

        // å¹´ã®é–‹å§‹æ—¥ã‹ã‚‰RIPAã‚¢ãƒ³ã‚«ãƒ¼ã¾ã§ã®é€šç®—æ—¥æ•°ï¼ˆripaAbsï¼‰
        // ripaAbs 0 = RIPA_ANCHORå¹´æœˆæ—¥
        function ripa_daysBeforeYear(y) {
            const anchorY = RIPA_ANCHOR.year;
            if (y === anchorY) return -RIPA_ANCHOR_DAY_IN_YEAR;

            if (y > anchorY) {
                let total = 0;
                for (let yr = anchorY; yr < y; yr++) {
                    total += ripa_yearDays(yr);
                }
                return total - RIPA_ANCHOR_DAY_IN_YEAR;
            } else {
                // y < anchorY
                let total = 0;
                for (let yr = y; yr < anchorY; yr++) {
                    total += ripa_yearDays(yr);
                }
                return -total - RIPA_ANCHOR_DAY_IN_YEAR;
            }
        }

        function ripa_daysBeforeMonth(month) {
            let s = 0;
            for (let i = 1; i < month; i++) s += RIPA_MONTHS[i - 1].days;
            return s;
        }

        // ripaAbs: RIPA_ANCHORå¹´æœˆæ—¥ = 0
        function ripa_toAbs(y, m, d) {
            return ripa_daysBeforeYear(y) + ripa_daysBeforeMonth(m) + (d - 1);
        }

        // ripaAbsã‹ã‚‰philAbsã¸
        function ripa_toPhilAbs(ripaAbs) {
            return ripaAbs + RIPA_ANCHOR_PHIL_ABS;
        }

        // philAbsã‹ã‚‰ripaAbsã¸
        function philAbs_toRipaAbs(philAbs) {
            return philAbs - RIPA_ANCHOR_PHIL_ABS;
        }

        // æ›œæ—¥ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆé–æ—¥ã‚’é™¤ãé€šç®—æ—¥æ•°ãƒ™ãƒ¼ã‚¹ï¼‰
        // RIPA_ANCHORå¹´æœˆæ—¥ã‚’åŸºæº–ã¨ã—ã¦æ›œæ—¥è¨ˆç®—
        // ã¾ãšRIPA_ANCHORã®æ›œæ—¥ã‚’æ±ºå®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹
        // ä»•æ§˜ã§ã¯æ˜ç¤ºã•ã‚Œã¦ã„ãªã„ã®ã§ã€0ï¼ˆé–‹æ›œæ—¥ï¼‰ã¨ã™ã‚‹
        const RIPA_EPOCH_DOW0 = 0;

        // é–æ—¥ã‚’é™¤ã„ãŸé€šç®—æ—¥æ•°ã§æ›œæ—¥ã‚’è¨ˆç®—
        function ripa_weekdayIndex(y, m, d) {
            // å¹´åˆã‹ã‚‰ãã®æ—¥ã¾ã§ã®ã€Œé€šå¸¸æ—¥æ•°ã€ï¼ˆé–æ—¥ã‚’é™¤ãï¼‰
            let dayCount = ripa_daysBeforeMonth(m) + (d - 1);

            // å‰å¹´ã¾ã§ã®ã€Œé€šå¸¸æ—¥æ•°ã€ï¼ˆé–æ—¥ã‚’é™¤ãï¼‰
            const anchorY = RIPA_ANCHOR.year;
            let yearDaysBeforeEpoch = 0;
            if (y > anchorY) {
                for (let yr = anchorY; yr < y; yr++) {
                    yearDaysBeforeEpoch += RIPA_YEAR_DAYS; // é–æ—¥ã‚’é™¤ã
                }
            } else if (y < anchorY) {
                for (let yr = y; yr < anchorY; yr++) {
                    yearDaysBeforeEpoch -= RIPA_YEAR_DAYS;
                }
            }

            const totalRegularDays = yearDaysBeforeEpoch + dayCount;
            return mod(RIPA_EPOCH_DOW0 + totalRegularDays, RIPA_WEEK_LEN);
        }

        // æœˆé½¢è¨ˆç®—ï¼ˆãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦ã®åŸºæº–ã‚’ä½¿ç”¨ï¼‰
        function ripa_lunarAgeForDay(y, m, d) {
            const ripaAbs = ripa_toAbs(y, m, d);
            const philAbs = ripa_toPhilAbs(ripaAbs);
            return phil_lunarAgeForAbsoluteDay(philAbs);
        }

        function ripa_dayHasNewMoon(y, m, d) {
            const ripaAbs = ripa_toAbs(y, m, d);
            const philAbs = ripa_toPhilAbs(ripaAbs);
            return phil_dayHasNewMoon(philAbs);
        }

        function ripa_dayHasFullMoon(y, m, d) {
            const ripaAbs = ripa_toAbs(y, m, d);
            const philAbs = ripa_toPhilAbs(ripaAbs);
            return phil_dayHasFullMoon(philAbs);
        }

        // ========================================
        // ä¿®æ­£ãƒªãƒ‘ãƒ©ã‚ªãƒæš¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ UI
        // ========================================
        const ripaYearEl = document.getElementById("ripa-year");
        const ripaViewEl = document.getElementById("ripa-view");
        const ripaMonthEl = document.getElementById("ripa-month");
        const ripaStatusEl = document.getElementById("ripa-status");
        const ripaCalEl = document.getElementById("ripa-calendar-grid");

        // æœˆã‚»ãƒ¬ã‚¯ãƒˆåˆæœŸåŒ–
        RIPA_MONTHS.forEach((m, i) => {
            const opt = document.createElement("option");
            opt.value = String(i + 1);
            opt.textContent = m.name;
            ripaMonthEl.appendChild(opt);
        });

        function ripa_buildMonthCard(year, month) {
            const m = RIPA_MONTHS[month - 1];
            const monthLen = m.days;
            const isLeap = ripa_isLeapYear(year);
            const isLastMonth = (month === 12);

            const startW = ripa_weekdayIndex(year, month, 1);

            const card = document.createElement("div");
            card.className = "month-card";

            const head = document.createElement("div");
            head.className = "month-head";
            head.innerHTML = `
              <div class="month-title">${m.name}</div>
              <div class="month-sub">${monthLen}æ—¥${(isLeap && isLastMonth) ? " + é–æ—¥" : ""}</div>
            `;
            card.appendChild(head);

            const dow = document.createElement("div");
            dow.className = "ripa-dow";
            for (let i = 0; i < RIPA_WEEK_LEN; i++) {
                const d = document.createElement("div");
                d.textContent = RIPA_DOW[i];
                dow.appendChild(d);
            }
            card.appendChild(dow);

            const days = document.createElement("div");
            days.className = "ripa-days";

            // å‰ã®ç©ºç™½
            for (let i = 0; i < startW; i++) {
                const e = document.createElement("div");
                e.className = "empty";
                e.textContent = ".";
                days.appendChild(e);
            }

            // æ—¥ä»˜
            for (let day = 1; day <= monthLen; day++) {
                const hasNew = ripa_dayHasNewMoon(year, month, day);
                const hasFull = ripa_dayHasFullMoon(year, month, day);
                const age = ripa_lunarAgeForDay(year, month, day);
                const isExactMoon = hasNew || hasFull;
                const phase = phaseForAge(age, isExactMoon);

                const cell = document.createElement("div");
                let cls = "day";
                if (hasNew) cls += " newmoon";
                if (hasFull) cls += " fullmoon";
                cell.className = cls;

                const moon = document.createElement("span");
                moon.className = "moonmark";
                moon.textContent = hasNew ? "ğŸŒ‘" : (hasFull ? "ğŸŒ•" : phase.mark);

                const num = document.createElement("span");
                num.textContent = String(day);

                cell.appendChild(moon);
                cell.appendChild(num);

                const w = ripa_weekdayIndex(year, month, day);

                cell.title = `æœˆé½¢ ${age.toFixed(3)}æ—¥ï¼ˆ${phase.name}ï¼‰`;

                days.appendChild(cell);
            }

            // é–æ—¥ï¼ˆ12æœˆã®å¾Œã€æ›œæ—¥ã«å±ã•ãªã„ç‹¬ç«‹æ—¥ï¼‰
            if (isLeap && isLastMonth) {
                const leapCell = document.createElement("div");
                leapCell.className = "day leapday";

                // é–æ—¥ã®æœˆç›¸è¨ˆç®—ï¼ˆãƒ«ãƒãƒ¼35æ—¥ã®ç¿Œæ—¥ã¨ã—ã¦ï¼‰
                const leapRipaAbs = ripa_toAbs(year, 12, 35) + 1;
                const leapPhilAbs = leapRipaAbs + RIPA_ANCHOR_PHIL_ABS;
                const leapAge = phil_lunarAgeForAbsoluteDay(leapPhilAbs);
                const leapPhase = phaseForAge(leapAge);

                const leapMoon = document.createElement("span");
                leapMoon.className = "moonmark";
                leapMoon.textContent = leapPhase.mark;

                const leapNum = document.createElement("span");
                leapNum.textContent = "é–";
                leapNum.style.fontSize = "11px";

                leapCell.appendChild(leapMoon);
                leapCell.appendChild(leapNum);
                leapCell.title = `${year}å¹´ é–æ—¥ï¼ˆæœˆãƒ»æ›œæ—¥ã«å±ã•ãªã„ç‹¬ç«‹æ—¥ï¼‰\næœˆé½¢ ${leapAge.toFixed(3)}æ—¥ï¼ˆ${leapPhase.name}ï¼‰`;

                days.appendChild(leapCell);
            }

            // æœ€çµ‚è¡Œã®æ¬ ã‘ã‚’åŸ‹ã‚ã‚‹
            const totalCells = startW + monthLen + (isLeap && isLastMonth ? 1 : 0);
            const pad = mod((RIPA_WEEK_LEN - mod(totalCells, RIPA_WEEK_LEN)), RIPA_WEEK_LEN);
            for (let i = 0; i < pad; i++) {
                const e = document.createElement("div");
                e.className = "empty";
                e.textContent = ".";
                days.appendChild(e);
            }

            card.appendChild(days);
            return card;
        }

        function ripa_render() {
            const yRaw = Number(ripaYearEl.value);
            const y = Number.isFinite(yRaw) ? Math.trunc(yRaw) : 728;
            ripaYearEl.value = String(y);

            const view = ripaViewEl.value;
            const m = Math.min(12, Math.max(1, Math.trunc(Number(ripaMonthEl.value || 1))));

            const isLeap = ripa_isLeapYear(y);

            ripaStatusEl.innerHTML = `
              <div>
                <span class="pill">å¹´ ${y}</span>
                <span class="pill ${isLeap ? "warn" : ""}">${isLeap ? "é–å¹´" : "å¹³å¹´"}</span>
                ${y < RIPA_LEAP_START_YEAR ? `<span class="pill">${RIPA_LEAP_START_YEAR}å¹´ä»¥å‰ã®ãŸã‚é–å¹´ãªã—</span>` : ""}
              </div>
            `;

            ripaCalEl.innerHTML = "";

            if (view === "month") {
                const wrap = document.createElement("div");
                wrap.className = "year-grid";
                wrap.style.gridTemplateColumns = "minmax(240px, 520px)";
                wrap.appendChild(ripa_buildMonthCard(y, m));
                ripaCalEl.appendChild(wrap);
                return;
            }

            const grid = document.createElement("div");
            grid.className = "year-grid";
            for (let mm = 1; mm <= 12; mm++) {
                grid.appendChild(ripa_buildMonthCard(y, mm));
            }
            ripaCalEl.appendChild(grid);
        }

        function ripa_syncUI() {
            ripaMonthEl.disabled = (ripaViewEl.value !== "month");
        }

        document.getElementById("ripa-render").addEventListener("click", ripa_render);
        ripaViewEl.addEventListener("change", () => { ripa_syncUI(); ripa_render(); });
        ripaYearEl.addEventListener("keydown", (e) => { if (e.key === "Enter") ripa_render(); });
        ripaMonthEl.addEventListener("change", ripa_render);

        // ========================================
        // æš¦å¤‰æ› UI
        // ========================================
        const pY = document.getElementById("pY");
        const pM = document.getElementById("pM");
        const pD = document.getElementById("pD");
        const fY = document.getElementById("fY");
        const fM = document.getElementById("fM");
        const fD = document.getElementById("fD");
        const rY = document.getElementById("rY");
        const rM = document.getElementById("rM");
        const rD = document.getElementById("rD");

        // å‡ºåŠ›è¦ç´ 
        const outP_fiik = document.getElementById("outP_fiik");
        const outP_ripa = document.getElementById("outP_ripa");
        const outF_phil = document.getElementById("outF_phil");
        const outF_ripa = document.getElementById("outF_ripa");
        const outR_phil = document.getElementById("outR_phil");
        const outR_fiik = document.getElementById("outR_fiik");

        // æœˆé½¢å‡ºåŠ›è¦ç´ 
        const outP_lunar = document.getElementById("outP_lunar");
        const outF_lunar = document.getElementById("outF_lunar");
        const outR_lunar = document.getElementById("outR_lunar");

        document.getElementById("anchorView").innerHTML =
            `ãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦ 2003/2/25 = ä¿®æ­£ãƒªãƒ‘ãƒ©ã‚ªãƒæš¦ 992/1/3<br>` +
            `ãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦ 1384/5/10 = ãƒ•ã‚£ãƒ¼ã‚¯æš¦ 1/1/1`;

        function setOut(el, s, isErr = false) {
            if (!el) return;
            el.innerHTML = isErr ? `<span class="err">${s}</span>` : s;
        }

        // ä¿®æ­£ãƒªãƒ‘ãƒ©ã‚ªãƒæš¦ â†’ philAbs
        function ripa_toPhilAbsFull(y, m, d) {
            const ripaAbs = ripa_toAbs(y, m, d);
            return ripa_toPhilAbs(ripaAbs);
        }

        // philAbs â†’ ä¿®æ­£ãƒªãƒ‘ãƒ©ã‚ªãƒæš¦
        function philAbs_toRipa(philAbs) {
            const ripaAbs = philAbs - RIPA_ANCHOR_PHIL_ABS;
            // ripaAbsã‹ã‚‰å¹´æœˆæ—¥ã‚’é€†ç®—
            // RIPA_ANCHORå¹´æœˆæ—¥ = ripaAbs 0
            let y = RIPA_ANCHOR.year;
            let rem = ripaAbs + RIPA_ANCHOR_DAY_IN_YEAR;

            if (rem >= 0) {
                while (rem >= ripa_yearDays(y)) {
                    rem -= ripa_yearDays(y);
                    y++;
                }
            } else {
                y = RIPA_ANCHOR.year - 1;
                while (rem < 0) {
                    rem += ripa_yearDays(y);
                    y--;
                }
                y++;
            }

            // æœˆã‚’ç‰¹å®š
            let m = 1;
            while (m <= 12 && rem >= RIPA_MONTHS[m - 1].days) {
                rem -= RIPA_MONTHS[m - 1].days;
                m++;
            }

            // é–æ—¥ãƒã‚§ãƒƒã‚¯ï¼ˆå¹´æœ«ã®é–æ—¥ï¼‰
            if (m > 12) {
                if (ripa_isLeapYear(y)) {
                    return { year: y, month: 12, day: 36, isLeap: true, isLeapDay: true };
                } else {
                    // ã‚¨ãƒ©ãƒ¼: é–å¹´ã§ãªã„ã®ã«æ—¥æ•°ãŒè¶…é
                    m = 12;
                    rem = RIPA_MONTHS[11].days - 1;
                }
            }

            const d = rem + 1;
            return { year: y, month: m, day: d, isLeap: ripa_isLeapYear(y), monthName: RIPA_MONTHS[m - 1].name };
        }

        // ========================================
        // æš¦å¤‰æ›ï¼šç›¸äº’åŒæœŸ
        // ========================================
        const outLunar = document.getElementById("outLunar");
        const philStatus = document.getElementById("philStatus");
        const ripaStatus = document.getElementById("ripaStatus");
        const fiikStatus = document.getElementById("fiikStatus");

        let syncing = false; // å†å¸°é˜²æ­¢ãƒ•ãƒ©ã‚°

        function updateLunarDisplay(philAbs) {
            const lunarAge = phil_lunarAgeForAbsoluteDay(philAbs);
            const hasNew = phil_dayHasNewMoon(philAbs);
            const hasFull = phil_dayHasFullMoon(philAbs);
            const isExactMoon = hasNew || hasFull;
            const phase = phaseForAge(lunarAge, isExactMoon);
            setOut(outLunar, `${lunarAge.toFixed(3)}æ—¥ï¼ˆ${phase.name}ï¼‰ ${phase.mark}`);
        }

        // ãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦ã‹ã‚‰ä»–ã®æš¦ã«åŒæœŸ
        function syncFromPhil() {
            if (syncing) return;
            syncing = true;
            try {
                const y = intOrNaN(pY.value), m = intOrNaN(pM.value), d = intOrNaN(pD.value);
                const philAbs = phil_toAbs(y, m, d);

                // æœˆé½¢è¡¨ç¤º
                updateLunarDisplay(philAbs);

                // ãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                const philLeap = phil_isLeapYear(y) ? "ï¼ˆé–å¹´ï¼‰" : "ï¼ˆå¹³å¹´ï¼‰";
                philStatus.textContent = philLeap;

                // â†’ ãƒ•ã‚£ãƒ¼ã‚¯æš¦
                const fiikAbs = philAbs - PHIL_AT_FIIK_EPOCH;
                const fiik = fiik_fromAbsToCivil(fiikAbs);
                fY.value = fiik.year;
                fM.value = fiik.month;
                fD.value = fiik.day;
                fiikStatus.textContent = fiik.isLeap ? "ï¼ˆé–å¹´ï¼‰" : "ï¼ˆå¹³å¹´ï¼‰";

                // â†’ ä¿®æ­£ãƒªãƒ‘ãƒ©ã‚ªãƒæš¦
                const ripa = philAbs_toRipa(philAbs);
                rY.value = ripa.year;
                rM.value = ripa.month;
                rD.value = ripa.isLeapDay ? 36 : ripa.day;
                ripaStatus.textContent = ripa.isLeap ? "ï¼ˆé–å¹´ï¼‰" : (ripa.year < 668 ? "668å¹´ä»¥å‰ã®ãŸã‚é–å¹´ãªã—" : "ï¼ˆå¹³å¹´ï¼‰");

                updateFiikDayMax();
                updateRipaDayMax();
            } catch (e) {
                setOut(outLunar, "â€”");
                philStatus.textContent = e.message || String(e);
            }
            syncing = false;
        }

        // ãƒ•ã‚£ãƒ¼ã‚¯æš¦ã‹ã‚‰ä»–ã®æš¦ã«åŒæœŸ
        function syncFromFiik() {
            if (syncing) return;
            syncing = true;
            try {
                const y = intOrNaN(fY.value), m = intOrNaN(fM.value), d = intOrNaN(fD.value);
                const fiikAbs = fiik_toAbsCivil(y, m, d);
                const philAbs = fiikAbs + PHIL_AT_FIIK_EPOCH;

                // æœˆé½¢è¡¨ç¤º
                updateLunarDisplay(philAbs);

                // ãƒ•ã‚£ãƒ¼ã‚¯æš¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                const info = fiik_getYearInfo(y);
                fiikStatus.textContent = info.isLeap ? "ï¼ˆé–å¹´ï¼‰" : "ï¼ˆå¹³å¹´ï¼‰";

                // â†’ ãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦
                const phil = phil_fromAbs(philAbs);
                pY.value = phil.year;
                pM.value = phil.month;
                pD.value = phil.day;
                philStatus.textContent = phil_isLeapYear(phil.year) ? "ï¼ˆé–å¹´ï¼‰" : "ï¼ˆå¹³å¹´ï¼‰";

                // â†’ ä¿®æ­£ãƒªãƒ‘ãƒ©ã‚ªãƒæš¦
                const ripa = philAbs_toRipa(philAbs);
                rY.value = ripa.year;
                rM.value = ripa.month;
                rD.value = ripa.isLeapDay ? 36 : ripa.day;
                ripaStatus.textContent = ripa.isLeap ? "ï¼ˆé–å¹´ï¼‰" : (ripa.year < 668 ? "668å¹´ä»¥å‰ã®ãŸã‚é–å¹´ãªã—" : "ï¼ˆå¹³å¹´ï¼‰");

                updatePhilDayMax();
                updateRipaDayMax();
            } catch (e) {
                setOut(outLunar, "â€”");
                fiikStatus.textContent = e.message || String(e);
            }
            syncing = false;
        }

        // ä¿®æ­£ãƒªãƒ‘ãƒ©ã‚ªãƒæš¦ã‹ã‚‰ä»–ã®æš¦ã«åŒæœŸ
        function syncFromRipa() {
            if (syncing) return;
            syncing = true;
            try {
                const y = intOrNaN(rY.value), m = intOrNaN(rM.value), d = intOrNaN(rD.value);

                // å…¥åŠ›æ¤œè¨¼
                if (m < 1 || m > 12) throw new Error("æœˆã¯1ã€œ12ã§ã™ã€‚");
                const maxDay = RIPA_MONTHS[m - 1].days;
                if (d < 1 || d > maxDay) throw new Error(`${RIPA_MONTHS[m - 1].name}æœˆã¯1ã€œ${maxDay}æ—¥ã§ã™ã€‚`);

                const philAbs = ripa_toPhilAbsFull(y, m, d);

                // æœˆé½¢è¡¨ç¤º
                updateLunarDisplay(philAbs);

                // ä¿®æ­£ãƒªãƒ‘ãƒ©ã‚ªãƒæš¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                ripaStatus.textContent = ripa_isLeapYear(y) ? "ï¼ˆé–å¹´ï¼‰" : (y < 668 ? "668å¹´ä»¥å‰ã®ãŸã‚é–å¹´ãªã—" : "ï¼ˆå¹³å¹´ï¼‰");

                // â†’ ãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦
                const phil = phil_fromAbs(philAbs);
                pY.value = phil.year;
                pM.value = phil.month;
                pD.value = phil.day;
                philStatus.textContent = phil_isLeapYear(phil.year) ? "ï¼ˆé–å¹´ï¼‰" : "ï¼ˆå¹³å¹´ï¼‰";

                // â†’ ãƒ•ã‚£ãƒ¼ã‚¯æš¦
                const fiikAbs = philAbs - PHIL_AT_FIIK_EPOCH;
                const fiik = fiik_fromAbsToCivil(fiikAbs);
                fY.value = fiik.year;
                fM.value = fiik.month;
                fD.value = fiik.day;
                fiikStatus.textContent = fiik.isLeap ? "ï¼ˆé–å¹´ï¼‰" : "ï¼ˆå¹³å¹´ï¼‰";

                updatePhilDayMax();
                updateFiikDayMax();
            } catch (e) {
                setOut(outLunar, "â€”");
                ripaStatus.textContent = e.message || String(e);
            }
            syncing = false;
        }

        // æ—¥ä»˜ã®æœ€å¤§å€¤ã‚’å‹•çš„ã«æ›´æ–°ã™ã‚‹é–¢æ•°
        function updatePhilDayMax() {
            const m = Math.min(12, Math.max(1, parseInt(pM.value) || 1));
            const y = parseInt(pY.value) || 0;
            const maxDay = phil_monthDaysInYear(y, m);
            pD.max = maxDay;
            if (parseInt(pD.value) > maxDay) pD.value = maxDay;
        }

        function updateFiikDayMax() {
            const y = parseInt(fY.value) || 1;
            const info = fiik_getYearInfo(y);
            const m = Math.min(info.monthsCount, Math.max(1, parseInt(fM.value) || 1));
            const idx0 = m - 1;
            const maxDay = info.monthDays[idx0];
            fD.max = maxDay;
            fM.max = info.monthsCount;
            if (parseInt(fD.value) > maxDay) fD.value = maxDay;
            if (parseInt(fM.value) > info.monthsCount) fM.value = info.monthsCount;
        }

        function updateRipaDayMax() {
            const m = Math.min(12, Math.max(1, parseInt(rM.value) || 1));
            const maxDay = RIPA_MONTHS[m - 1].days;
            rD.max = maxDay;
            if (parseInt(rD.value) > maxDay) rD.value = maxDay;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        [pY, pM, pD].forEach(el => el.addEventListener("input", () => { updatePhilDayMax(); syncFromPhil(); }));
        [rY, rM, rD].forEach(el => el.addEventListener("input", () => { updateRipaDayMax(); syncFromRipa(); }));
        [fM, fD].forEach(el => el.addEventListener("input", () => { updateFiikDayMax(); syncFromFiik(); }));

        // ãƒ•ã‚£ãƒ¼ã‚¯æš¦ã®0å¹´ã‚¹ã‚­ãƒƒãƒ—å‡¦ç†
        let fiikConvLastYear = parseInt(fY.value) || 1;
        fY.addEventListener("input", () => {
            const current = parseInt(fY.value);
            if (current === 0) {
                if (fiikConvLastYear > 0) {
                    fY.value = -1;
                } else {
                    fY.value = 1;
                }
            }
            fiikConvLastYear = parseInt(fY.value) || 1;
            updateFiikDayMax();
            syncFromFiik();
        });

        // ========================================
        // åˆæœŸåŒ–
        // ========================================
        fiik_syncMonthOptions();
        fiik_render();
        phil_syncUI();
        phil_render();
        ripa_syncUI();
        ripa_render();
        updatePhilDayMax();
        updateFiikDayMax();
        updateRipaDayMax();
        syncFromPhil();  // åˆæœŸåŒæœŸ
    </script>
</body>

</html>