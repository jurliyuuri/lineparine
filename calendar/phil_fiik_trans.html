<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ピリフィアー暦 ↔ フィーク暦 変換（fiik: 0年なし）</title>
  <style>
    :root{
      --bg:#0b0c10; --panel:#12141b; --panel2:#171a23; --text:#e8eaf0; --muted:#a8afc3;
      --line:#24283a; --accent:#7aa2f7; --warn:#f7768e;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif; background:linear-gradient(180deg,var(--bg),#07080c); color:var(--text)}
    header{padding:18px 16px 10px; border-bottom:1px solid var(--line); background:rgba(18,20,27,.75); position:sticky; top:0; backdrop-filter:blur(10px); z-index:10}
    h1{margin:0; font-size:16px; font-weight:900; letter-spacing:.2px}
    .sub{margin-top:6px; color:var(--muted); font-size:13px; line-height:1.5}
    main{padding:18px 16px 40px; max-width:1100px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--panel); border:1px solid var(--line); border-radius:16px; overflow:hidden; box-shadow:0 8px 28px rgba(0,0,0,.35)}
    .card h2{margin:0; padding:12px 12px 10px; font-size:14px; font-weight:900; border-bottom:1px solid var(--line); background:linear-gradient(180deg,rgba(255,255,255,.04),transparent)}
    .card .body{padding:12px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:end}
    label{font-size:12px; color:var(--muted)}
    input[type="number"]{
      background:var(--panel2); border:1px solid var(--line); color:var(--text);
      padding:10px 12px; border-radius:10px; outline:none; min-width:140px;
    }
    button{
      background:var(--accent); border:0; color:#0b0c10; padding:10px 14px; border-radius:10px;
      font-weight:800; cursor:pointer;
    }
    button:active{transform:translateY(1px)}
    .out{margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.03)}
    .out .k{color:var(--muted); font-size:12px}
    .out .v{font-size:14px; margin-top:6px; line-height:1.5}
    .err{color:var(--warn)}
    code{background:rgba(255,255,255,.06); padding:2px 6px; border-radius:8px}
    details{margin-top:10px}
    details summary{cursor:pointer; color:var(--muted); font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>
<body>
<header>
  <h1>ピリフィアー暦（phil） ↔ フィーク暦（fiik） 変換</h1>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h2>ピリフィアー暦 → フィーク暦</h2>
      <div class="body">
        <div class="row">
          <div>
            <label for="pY">phil 年</label><br>
            <input id="pY" type="number" step="1" value="1384">
          </div>
          <div>
            <label for="pM">phil 月</label><br>
            <input id="pM" type="number" step="1" min="1" max="12" value="5">
          </div>
          <div>
            <label for="pD">phil 日</label><br>
            <input id="pD" type="number" step="1" min="1" value="10">
          </div>
          <div>
            <button id="btnP">変換</button>
          </div>
        </div>

        <div class="out" id="outP">
          <div class="k">出力</div>
          <div class="v mono">—</div>
        </div>

        <details>
          <summary>デバッグ（通算日）</summary>
          <div class="out" style="margin-top:8px" id="dbgP">
            <div class="k">absDay</div>
            <div class="v mono">—</div>
          </div>
        </details>
      </div>
    </section>

    <section class="card">
      <h2>フィーク暦 → ピリフィアー暦</h2>
      <div class="body">
        <div class="row">
          <div>
            <label for="fY">fiik 年</label><br>
            <input id="fY" type="number" step="1" value="1" placeholder="…,-2,-1,1,2,…">
          </div>
          <div>
            <label for="fM">fiik 月（閏年のみ13可）</label><br>
            <input id="fM" type="number" step="1" min="1" max="13" value="1">
          </div>
          <div>
            <label for="fD">fiik 日</label><br>
            <input id="fD" type="number" step="1" min="1" value="1">
          </div>
          <div>
            <button id="btnF">変換</button>
          </div>
        </div>

        <div class="out" id="outF">
          <div class="k">出力</div>
          <div class="v mono">—</div>
        </div>

        <details>
          <summary>デバッグ（通算日）</summary>
          <div class="out" style="margin-top:8px" id="dbgF">
            <div class="k">absDay</div>
            <div class="v mono">—</div>
          </div>
        </details>
      </div>
    </section>
  </div>

  <details style="margin-top:14px">
    <summary>実装メモ（アンカー定数）</summary>
    <div class="out" style="margin-top:8px">
      <div class="k">現在のアンカー</div>
      <div class="v mono" id="anchorView">—</div>
    </div>
  </details>
</main>

<script>
/* ========= 共通 ========= */
function mod(n, m){ return ((n % m) + m) % m; }
function sum(arr){ return arr.reduce((a,b)=>a+b,0); }
function intOrNaN(v){ const n = Number(v); return Number.isFinite(n) ? Math.trunc(n) : NaN; }

/* ========= ピリフィアー暦（phil） ========= */
const PHIL_MONTHS = [
  { name:"レナ", days:31 },
  { name:"フューア", days:30 },
  { name:"ユスツァプローサ", days:30 },
  { name:"ケインテル", days:31 },
  { name:"シュトゥーガ", days:30 },
  { name:"シュツァー", days:30 },
  { name:"ユンカー", days:31 },
  { name:"ユナフラ", days:30 },
  { name:"シェーター", days:30 },
  { name:"フィレナ", days:31 },
  { name:"ヴェルガナ", days:30 },
  { name:"ルバー", days:31 }
];

const PHIL_SPECIAL_LEAP_POS = new Set([250, 750, 1250]);
const PHIL_CYCLE_YEARS = 2000;
const PHIL_LEAPS_PER_CYCLE = 503;
const PHIL_CYCLE_DAYS = PHIL_CYCLE_YEARS * 365 + PHIL_LEAPS_PER_CYCLE; // 730503

function phil_cycleInfo(y){
  const q = Math.floor((y - 1) / PHIL_CYCLE_YEARS);
  const pos = mod((y - 1), PHIL_CYCLE_YEARS) + 1; // 1..2000
  return { q, pos };
}
function phil_isLeapYear(y){
  const { pos } = phil_cycleInfo(y);
  return (pos % 4 === 0) || PHIL_SPECIAL_LEAP_POS.has(pos);
}
function phil_prefixLeapsInCycle(n){
  if (n <= 0) return 0;
  let c = Math.floor(n / 4);
  if (n >= 250) c += 1;
  if (n >= 750) c += 1;
  if (n >= 1250) c += 1;
  return c;
}
function phil_offsetWithinCycleToYearStart(pos){
  const prevYears = pos - 1;
  return prevYears * 365 + phil_prefixLeapsInCycle(prevYears);
}
function phil_daysBeforeYear(y){
  const { q, pos } = phil_cycleInfo(y);
  return q * PHIL_CYCLE_DAYS + phil_offsetWithinCycleToYearStart(pos);
}
function phil_daysBeforeMonth(month){
  let s = 0;
  for (let i=1; i<month; i++) s += PHIL_MONTHS[i-1].days;
  return s;
}
function phil_monthDaysInYear(year, month){
  const base = PHIL_MONTHS[month-1].days;
  return (month === 12 && phil_isLeapYear(year)) ? base + 1 : base;
}
function phil_toAbs(y, m, d){
  if (!Number.isFinite(y) || !Number.isFinite(m) || !Number.isFinite(d)) throw new Error("入力が数値ではありません。");
  if (m < 1 || m > 12) throw new Error("phil 月は 1〜12 です。");
  const md = phil_monthDaysInYear(y, m);
  if (d < 1 || d > md) throw new Error(`phil 日はその月では 1〜${md} です。`);
  return phil_daysBeforeYear(y) + phil_daysBeforeMonth(m) + (d - 1);
}
function phil_fromAbs(absDay){
  if (!Number.isFinite(absDay)) throw new Error("absDay が不正です。");

  const q = Math.floor(absDay / PHIL_CYCLE_DAYS);
  let rem = absDay - q * PHIL_CYCLE_DAYS;

  const startOfPos = (pos)=>phil_offsetWithinCycleToYearStart(pos);
  let lo = 1, hi = PHIL_CYCLE_YEARS + 1;
  while (lo + 1 < hi){
    const mid = Math.floor((lo + hi) / 2);
    if (startOfPos(mid) <= rem) lo = mid;
    else hi = mid;
  }
  const pos = lo;
  const year = q * PHIL_CYCLE_YEARS + pos;

  let dayOfYear0 = rem - startOfPos(pos);
  let month = 1;
  for (; month <= 12; month++){
    const len = phil_monthDaysInYear(year, month);
    if (dayOfYear0 < len) break;
    dayOfYear0 -= len;
  }
  const day = dayOfYear0 + 1;
  return { year, month, day };
}

/* ========= フィーク暦（fiik）: 0年なし =========
   計算は内部的に「天文学的年（year 0 あり）」へ変換して行い、
   入出力は「0年なし（…, -2, -1, 1, 2, …）」で扱う。
*/
function fiik_civilToAstroYear(yCivil){
  if (!Number.isFinite(yCivil)) throw new Error("fiik 年が不正です。");
  if (yCivil === 0) throw new Error("fiik には 0年がありません（…, -2年, -1年, 1年, 2年, …）。");
  return (yCivil > 0) ? yCivil : (yCivil + 1); // -1→0, -2→-1, ...
}
function fiik_astroToCivilYear(yAstro){
  return (yAstro > 0) ? yAstro : (yAstro - 1); // 0→-1, -1→-2, ...
}

const FIIK_LEAP_POS = new Set([3, 6, 8, 11, 14, 17]);
const FIIK_YEAR_CYCLE = 17;

const FIIK_COMMON_MONTH_DAYS = [30,29,30,29,30,29,30,29,30,29,30,30];
const FIIK_LEAP_MONTH_DAYS   = [30,29,30,29,30,29,30,29,30,29,30,29,30];
const FIIK_COMMON_YEAR_DAYS = sum(FIIK_COMMON_MONTH_DAYS);
const FIIK_LEAP_YEAR_DAYS   = sum(FIIK_LEAP_MONTH_DAYS);

const FIIK_CYCLE_YEAR_DAYS = Array.from({length:FIIK_YEAR_CYCLE}, (_,i)=>{
  const r = i + 1;
  return FIIK_LEAP_POS.has(r) ? FIIK_LEAP_YEAR_DAYS : FIIK_COMMON_YEAR_DAYS;
});
const FIIK_CYCLE_DAYS_TOTAL = sum(FIIK_CYCLE_YEAR_DAYS); // 6209

function fiik_yearInfoAstro(yAstro){
  const r = mod((yAstro - 1), FIIK_YEAR_CYCLE) + 1; // 1..17
  const isLeap = FIIK_LEAP_POS.has(r);
  const monthDays = isLeap ? FIIK_LEAP_MONTH_DAYS : FIIK_COMMON_MONTH_DAYS;
  return { yAstro, yearInCycle:r, isLeap, monthDays, monthsCount:monthDays.length, yearDays:isLeap?FIIK_LEAP_YEAR_DAYS:FIIK_COMMON_YEAR_DAYS };
}

function fiik_toAbsCivil(yCivil, m1, d){
  if (!Number.isFinite(m1) || !Number.isFinite(d)) throw new Error("入力が数値ではありません。");
  if (m1 < 1 || m1 > 13) throw new Error("fiik 月は 1〜13 です（13月は閏年のみ）。");

  const yAstro = fiik_civilToAstroYear(yCivil);
  const info = fiik_yearInfoAstro(yAstro);

  if (m1 > info.monthsCount) throw new Error("その年は閏年ではないため 13月は存在しません。");
  const m0 = m1 - 1;
  const md = info.monthDays[m0];
  if (d < 1 || d > md) throw new Error(`fiik 日はその月では 1〜${md} です。`);

  const yearsBefore = yAstro - 1;
  const fullCycles = Math.floor(yearsBefore / FIIK_YEAR_CYCLE);
  const within = mod(yearsBefore, FIIK_YEAR_CYCLE);

  let total = fullCycles * FIIK_CYCLE_DAYS_TOTAL;
  for (let i=0; i<within; i++) total += FIIK_CYCLE_YEAR_DAYS[i];

  for (let i=0; i<m0; i++) total += info.monthDays[i];
  total += (d - 1);
  return total;
}

function fiik_fromAbsToCivil(absDay){
  if (!Number.isFinite(absDay)) throw new Error("absDay が不正です。");

  const fullCycles = Math.floor(absDay / FIIK_CYCLE_DAYS_TOTAL);
  let rem = absDay - fullCycles * FIIK_CYCLE_DAYS_TOTAL;

  let withinIdx = 0;
  while (withinIdx < FIIK_YEAR_CYCLE && rem >= FIIK_CYCLE_YEAR_DAYS[withinIdx]){
    rem -= FIIK_CYCLE_YEAR_DAYS[withinIdx];
    withinIdx++;
  }
  const yAstro = fullCycles * FIIK_YEAR_CYCLE + withinIdx + 1;

  const info = fiik_yearInfoAstro(yAstro);
  let m0 = 0;
  while (m0 < info.monthsCount && rem >= info.monthDays[m0]){
    rem -= info.monthDays[m0];
    m0++;
  }
  const month = m0 + 1;
  const day = rem + 1;

  const yCivil = fiik_astroToCivilYear(yAstro);
  return { year:yCivil, month, day, isLeap: info.isLeap, yearAstro:yAstro };
}

/* ========= 暦間アンカー ========= */
const ANCHOR_PHIL = { year:1384, month:5, day:10 };
const PHIL_AT_FIIK_EPOCH = phil_toAbs(ANCHOR_PHIL.year, ANCHOR_PHIL.month, ANCHOR_PHIL.day);

function philToFiik(y,m,d){
  const philAbs = phil_toAbs(y,m,d);
  const fiikAbs = philAbs - PHIL_AT_FIIK_EPOCH;
  const fiik = fiik_fromAbsToCivil(fiikAbs);
  return { philAbs, fiikAbs, fiik };
}
function fiikToPhil(yCivil,m,d){
  const fiikAbs = fiik_toAbsCivil(yCivil,m,d);
  const philAbs = fiikAbs + PHIL_AT_FIIK_EPOCH;
  const phil = phil_fromAbs(philAbs);
  return { fiikAbs, philAbs, phil };
}

/* ========= UI ========= */
const pY = document.getElementById("pY");
const pM = document.getElementById("pM");
const pD = document.getElementById("pD");
const fY = document.getElementById("fY");
const fM = document.getElementById("fM");
const fD = document.getElementById("fD");

const outP = document.querySelector("#outP .v");
const dbgP = document.querySelector("#dbgP .v");
const outF = document.querySelector("#outF .v");
const dbgF = document.querySelector("#dbgF .v");

document.getElementById("anchorView").textContent =
  `phil ${ANCHOR_PHIL.year}/${ANCHOR_PHIL.month}/${ANCHOR_PHIL.day} -> philAbs ${PHIL_AT_FIIK_EPOCH} が fiikAbs 0 (fiik 1/1/1) に対応`;

function setOut(el, s, isErr=false){
  el.innerHTML = isErr ? `<span class="err">${s}</span>` : s;
}

function doPhilToFiik(){
  try{
    const y = intOrNaN(pY.value), m = intOrNaN(pM.value), d = intOrNaN(pD.value);
    const { philAbs, fiikAbs, fiik } = philToFiik(y,m,d);
    const leapTag = fiik.isLeap ? "（閏年）" : "";
    setOut(outP, `fiik ${fiik.year}/${fiik.month}/${fiik.day} ${leapTag}`);
    setOut(dbgP, `philAbs ${philAbs}  →  fiikAbs ${fiikAbs}  （内部: fiikAstroYear ${fiik.yearAstro}）`);
  }catch(e){
    setOut(outP, e.message || String(e), true);
    setOut(dbgP, "—");
  }
}

function doFiikToPhil(){
  try{
    const y = intOrNaN(fY.value), m = intOrNaN(fM.value), d = intOrNaN(fD.value);
    const { fiikAbs, philAbs, phil } = fiikToPhil(y,m,d);
    const md = phil_monthDaysInYear(phil.year, phil.month);
    const leapTag = (phil.month===12 && md===32) ? "（閏日あり年）" : "";
    const mName = PHIL_MONTHS[phil.month-1]?.name ?? String(phil.month);
    setOut(outF, `phil ${phil.year}/${phil.month}/${phil.day}（${mName}） ${leapTag}`);
    setOut(dbgF, `fiikAbs ${fiikAbs}  →  philAbs ${philAbs}`);
  }catch(e){
    setOut(outF, e.message || String(e), true);
    setOut(dbgF, "—");
  }
}

document.getElementById("btnP").addEventListener("click", doPhilToFiik);
document.getElementById("btnF").addEventListener("click", doFiikToPhil);

[pY,pM,pD].forEach(el=>el.addEventListener("input", doPhilToFiik));
[fY,fM,fD].forEach(el=>el.addEventListener("input", doFiikToPhil));

doPhilToFiik();
doFiikToPhil();
</script>
</body>
</html>