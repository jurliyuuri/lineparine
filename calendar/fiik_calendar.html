<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ãƒ•ã‚£ãƒ¼ã‚¯æš¦</title>

  <style>
    /* ===== ãƒ”ãƒªãƒ•ã‚£ã‚¢ãƒ¼æš¦ã®è¦‹ãŸç›®ã«å¯„ã›ãŸãƒˆãƒ¼ã‚¯ãƒ³ ===== */
    :root {
      --bg: #0b0c10;
      --panel: #12141b;
      --panel2: #171a23;
      --text: #e8eaf0;
      --muted: #a8afc3;
      --line: #24283a;
      --accent: #7aa2f7;
      --warn: #f7768e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
      background: linear-gradient(180deg, var(--bg), #07080c);
      color: var(--text);
    }
    header {
      padding: 20px 16px 8px;
      border-bottom: 1px solid var(--line);
      background: rgba(18,20,27,0.75);
      position: sticky;
      top: 0;
      backdrop-filter: blur(10px);
      z-index: 10;
    }
    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    label { font-size: 14px; color: var(--muted); }
    input[type="number"], select {
      background: var(--panel2);
      border: 1px solid var(--line);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      outline: none;
      min-width: 140px;
    }
    button {
      background: var(--accent);
      border: 0;
      color: #0b0c10;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
    }
    button:active { transform: translateY(1px); }
    .meta {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.4;
      margin-top: 10px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(122,162,247,0.14);
      border: 1px solid rgba(122,162,247,0.28);
      color: var(--text);
      font-size: 12px;
    }
    .pill.warn {
      background: rgba(247,118,142,0.12);
      border-color: rgba(247,118,142,0.25);
    }

    main { padding: 18px 16px 40px; }
    .note {
      margin-top: 14px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.6;
      max-width: 1100px;
    }
    code {
      background: rgba(255,255,255,0.06);
      padding: 2px 6px;
      border-radius: 8px;
    }

    /* ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆåæ›œåˆ¶ã«å¯¾å¿œï¼‰ ===== */
    .year-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(280px, 1fr));
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 1100px) { .year-grid { grid-template-columns: repeat(2, minmax(280px, 1fr)); } }
    @media (max-width: 720px)  { .year-grid { grid-template-columns: 1fr; } }

    .month-card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 28px rgba(0,0,0,0.35);
    }
    .month-head {
      padding: 12px 12px 10px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), transparent);
    }
    .month-title { font-weight: 800; letter-spacing: 0.3px; }
    .month-sub { color: var(--muted); font-size: 12px; }

    .dow, .days {
      display: grid;
      grid-template-columns: repeat(10, 1fr); /* â˜…åæ›œåˆ¶ï¼š10åˆ— */
    }
    .dow div {
      padding: 8px 6px;
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,0.02);
      white-space: nowrap;
    }
    .days div {
      height: 36px;
      display: grid;
      place-items: center;
      border-bottom: 1px solid var(--line);
      border-right: 1px solid var(--line);
      font-size: 13px;
      background: rgba(255,255,255,0.02);
    }
    .days div:nth-child(10n) { border-right: 0; } /* â˜…10åˆ—ã®è¡Œæœ« */
    .days .empty { background: rgba(255,255,255,0.01); color: transparent; }
    
    /* è¿½è¨˜ï¼šæ—¥ã‚»ãƒ«å†…ã«æœˆç›¸ã‚’ç½®ã */
    .days .day { position: relative; }

    .moonmark{
      position: absolute;
      top: 3px;
      left: 4px;
      font-size: 12px;
      line-height: 1;
      font-family: system-ui, "Apple Color Emoji", "Segoe UI Emoji", sans-serif;
      opacity: .9;
    }

/* è¿½è¨˜ï¼šæ–°æœˆãƒ»æº€æœˆã‚’ç›®ç«‹ãŸã›ã‚‹ */
.days .newmoon{
  outline: 2px solid rgba(247,118,142,0.55);
  outline-offset: -2px;
  box-shadow: 0 0 0 3px rgba(247,118,142,0.12) inset;
}
.days .fullmoon{
  outline: 2px solid rgba(122,162,247,0.65);
  outline-offset: -2px;
  box-shadow: 0 0 0 3px rgba(122,162,247,0.12) inset;
}

    /* é–æœˆï¼ˆ13æœˆï¼‰ã‚’è»½ãç›®ç«‹ãŸã›ã‚‹ï¼ˆè¦‹å‡ºã—å´ã§è¡¨ç¤ºï¼‰ */
    .month-title .leap-badge{
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      margin-left: 8px;
      background: rgba(247,118,142,0.12);
      border: 1px solid rgba(247,118,142,0.25);
      color: var(--text);
      font-weight: 800;
      letter-spacing: .2px;
    }
  </style>
</head>

<body>
<header>
  <div class="row">
    <div>
      <div style="font-weight:900; font-size:16px;">ãƒ•ã‚£ãƒ¼ã‚¯æš¦</div>
    </div>

    <div class="controls">
      <div>
        <label for="year">å¹´</label><br />
        <input id="year" type="number" step="1" value="1" />
      </div>
      <div>
        <label for="view">è¡¨ç¤º</label><br />
        <select id="view">
          <option value="year" selected>å¹´ï¼ˆå…¨æœˆï¼‰</option>
          <option value="month">æœˆï¼ˆ1ã¤ã ã‘ï¼‰</option>
        </select>
      </div>
      <div>
        <label for="month">æœˆ</label><br />
        <select id="month"></select>
      </div>
      <div style="align-self:end;">
        <button id="render">ç”Ÿæˆ</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div id="status" class="note"></div>
  <div id="calendar"></div>
</main>

<script>
  // ===== æš¦ä»•æ§˜=====
  const LEAP_POS = new Set([3, 6, 8, 11, 14, 17]); // 17å¹´å‘¨æœŸå†…ã®é–å¹´
  const YEAR_CYCLE = 17;

  const COMMON_MONTH_DAYS = [30,29,30,29,30,29,30,29,30,29,30,30];      // 355
  const LEAP_MONTH_DAYS   = [30,29,30,29,30,29,30,29,30,29,30,29,30];   // 384

  const COMMON_YEAR_DAYS = sum(COMMON_MONTH_DAYS);
  const LEAP_YEAR_DAYS   = sum(LEAP_MONTH_DAYS);

  // 17å¹´ã‚µã‚¤ã‚¯ãƒ«ã®å¹´æ—¥æ•°ï¼ˆå›ºå®šï¼‰
  const CYCLE_YEAR_DAYS = Array.from({length: YEAR_CYCLE}, (_, i) => {
    const r = i + 1;
    return LEAP_POS.has(r) ? LEAP_YEAR_DAYS : COMMON_YEAR_DAYS;
  });
  const CYCLE_DAYS_TOTAL = sum(CYCLE_YEAR_DAYS); // 6209

  // ===== åæ›œåˆ¶ =====
  const WEEK_LEN = 10;
  const DOW = ["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","ä¸ƒ","å…«","ä¹","å"];
  const EPOCH_DOW0 = 0; // 1å¹´1æœˆ1æ—¥ï¼ä¸€æ›œæ—¥

  // ===== UI =====
  const yearEl  = document.getElementById("year");
  const viewEl  = document.getElementById("view");
  const monthEl = document.getElementById("month");
  const statusEl = document.getElementById("status");
  const calEl = document.getElementById("calendar");

  // æ•°å­¦çš„modï¼ˆè² æ•°ã§ã‚‚0..m-1ï¼‰
  function mod(n, m) {
    return ((n % m) + m) % m;
  }

  // ===== æœˆé½¢ï¼ˆæœ”æœ›æœˆï¼‰ =====
const SYNODIC_MONTH = 29.5660340294;

// 1å¹´1æœˆ1æ—¥ã®æœˆé½¢ï¼ˆæ­£ç¢ºã«ï¼‰
const EPOCH_LUNAR_AGE = 0.6860292012;

// 8åˆ†å‰²ã®ç°¡æ˜“æœˆç›¸
const PHASES = [
  { name: "æ–°æœˆ",   mark: "ğŸŒ‘" },
  { name: "ä¸‰æ—¥æœˆ", mark: "ğŸŒ’" },
  { name: "ä¸Šå¼¦",   mark: "ğŸŒ“" },
  { name: "åä¸‰å¤œ", mark: "ğŸŒ”" },
  { name: "æº€æœˆ",   mark: "ğŸŒ•" },
  { name: "åå…­å¤œ", mark: "ğŸŒ–" },
  { name: "ä¸‹å¼¦",   mark: "ğŸŒ—" },
  { name: "äºŒåå…­å¤œ", mark: "ğŸŒ˜" },
];

const MOON_EPS = 1e-6; // æ—¥å˜ä½ã®è¨±å®¹èª¤å·®ï¼ˆæµ®å‹•å°æ•°ã®å¢ƒç•Œå¯¾ç­–ï¼‰

function lunarAgeAtAbsDay(absDay){
  // absDay=0 ãŒ 1å¹´1æœˆ1æ—¥ï¼ˆãã®æ—¥ã®å§‹ã¾ã‚Šï¼‰ã«å¯¾å¿œ
  return mod(EPOCH_LUNAR_AGE + absDay, SYNODIC_MONTH);
}

function phaseForAge(age){
  const idx = Math.floor((age / SYNODIC_MONTH) * 8) % 8;
  return PHASES[idx];
}

function dayHasNewMoon(absDay){
  const S = SYNODIC_MONTH;
  const u = EPOCH_LUNAR_AGE + absDay; // ãã®æ—¥ã®å§‹ã¾ã‚Šæ™‚ç‚¹ã®â€œé€£ç¶šæœˆé½¢â€
  const a = Math.floor(u / S);
  const b = Math.floor((u + 1) / S); // 1æ—¥å¾Œã¾ã§ã«å¢ƒç•Œã‚’è·¨ãã‹
  const r = mod(u, S);
  const atBoundary = (r < MOON_EPS) || (S - r < MOON_EPS);
  return (a !== b) || atBoundary;
}

function dayHasFullMoon(absDay){
  const S = SYNODIC_MONTH;
  // æº€æœˆã¯ (k+0.5)S ãªã®ã§ã€S/2 ãšã‚‰ã—ã¦ â€œæ–°æœˆåˆ¤å®šâ€ã¨åŒã˜åˆ¤å®šã‚’ã™ã‚‹
  const u = (EPOCH_LUNAR_AGE + absDay) - (S / 2);
  const a = Math.floor(u / S);
  const b = Math.floor((u + 1) / S);
  const r = mod(u, S);
  const atBoundary = (r < MOON_EPS) || (S - r < MOON_EPS);
  return (a !== b) || atBoundary;
}

  function getYearInfo(Y){
    const y = Math.trunc(Number(Y) || 1);
    const cycleIndex = Math.floor((y - 1) / YEAR_CYCLE);        // 0-based
    const r = mod((y - 1), YEAR_CYCLE) + 1;                     // 1..17
    const isLeap = LEAP_POS.has(r);
    const monthDays = isLeap ? LEAP_MONTH_DAYS.slice() : COMMON_MONTH_DAYS.slice();
    return {
      y,
      cycleIndex,
      yearInCycle: r,
      isLeap,
      monthDays,
      monthsCount: monthDays.length,
      yearDays: isLeap ? LEAP_YEAR_DAYS : COMMON_YEAR_DAYS
    };
  }

  // å¹´1/æœˆ1/æ—¥1 ã‹ã‚‰ã®é€šç®—æ—¥æ•°ï¼ˆ0-basedï¼‰
  function daysSinceEpoch(year, monthIndex0, day){
    const y = Math.trunc(Number(year) || 1);
    const m = Math.max(0, Math.trunc(Number(monthIndex0) || 0));
    const d = Math.max(1, Math.trunc(Number(day) || 1));

    const yearsBefore = y - 1;

    // â˜…è² æ•°ã§ã‚‚OKãªåˆ†è§£ï¼ˆæ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«æ–¹å¼ï¼‰
    const fullCycles = Math.floor(yearsBefore / YEAR_CYCLE); // â€¦,-2,-1,0,1,2,...
    const within = mod(yearsBefore, YEAR_CYCLE);             // 0..16

    let total = fullCycles * CYCLE_DAYS_TOTAL;

    // å‘¨æœŸå†…ã§ year ã®æ‰‹å‰ã«ã‚ã‚‹å¹´ã®åˆè¨ˆæ—¥æ•°ã‚’è¶³ã™
    for (let i = 0; i < within; i++) total += CYCLE_YEAR_DAYS[i];

    const yi = getYearInfo(y);
    for (let i = 0; i < m; i++) total += yi.monthDays[i];

    total += (d - 1);
    return total; // â˜…è² ã«ã‚‚ãªã‚Šå¾—ã‚‹ï¼ˆå¹´0/è² å¹´ã§ï¼‰
  }

  // 0=ä¸€æ›œæ—¥, ..., 9=åæ›œæ—¥
  function weekdayIndex(year, monthIndex0, day){
    const t = daysSinceEpoch(year, monthIndex0, day);
    return mod(EPOCH_DOW0 + mod(t, WEEK_LEN), WEEK_LEN);
  }

  function syncMonthOptions(){
    const info = getYearInfo(yearEl.value);
    const prev = Number(monthEl.value || 1);

    monthEl.innerHTML = "";
    for (let i = 1; i <= info.monthsCount; i++){
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = (info.isLeap && i === 13) ? "é–13æœˆ" : `${i}æœˆ`;
      monthEl.appendChild(opt);
    }

    // ã§ãã‚‹ã ã‘å…ƒã®é¸æŠã‚’ç¶­æŒ
    const next = Math.min(info.monthsCount, Math.max(1, prev));
    monthEl.value = String(next);

    // viewãŒmonthã®ã¨ãã ã‘æœ‰åŠ¹
    monthEl.disabled = (viewEl.value !== "month");
  }

  function buildMonthCard(year, month1){
    const info = getYearInfo(year);
    const idx0 = month1 - 1;
    const daysInMonth = info.monthDays[idx0];

    const startAbs = daysSinceEpoch(info.y, idx0, 1);
    const startW = weekdayIndex(info.y, idx0, 1); // 0..9

    const card = document.createElement("div");
    card.className = "month-card";

    const isIntercalary = (info.isLeap && month1 === 13);

    const head = document.createElement("div");
    head.className = "month-head";
    head.innerHTML = `
      <div class="month-title">
        ${isIntercalary ? `13æœˆ <span class="leap-badge">é–</span>` : `${month1}æœˆ`}
      </div>
      <div class="month-sub">${daysInMonth}æ—¥</div>
    `;
    card.appendChild(head);

    const dow = document.createElement("div");
    dow.className = "dow";
    for (let i=0; i<WEEK_LEN; i++){
      const d = document.createElement("div");
      d.textContent = DOW[i];
      dow.appendChild(d);
    }
    card.appendChild(dow);

    const days = document.createElement("div");
    days.className = "days";

    // å‰ã®ç©ºç™½
    for (let i=0; i<startW; i++){
      const e = document.createElement("div");
      e.className = "empty";
      e.textContent = ".";
      days.appendChild(e);
    }

    // æ—¥ä»˜ï¼ˆï¼‹æœˆç›¸ï¼‰
    for (let day=1; day<=daysInMonth; day++){
      const absDay = startAbs + (day - 1);

      const hasNew  = dayHasNewMoon(absDay);
      const hasFull = dayHasFullMoon(absDay);

      const age = lunarAgeAtAbsDay(absDay);
      const phase = phaseForAge(age);

      const cell = document.createElement("div");
      let cls = "day";
      if (hasNew)  cls += " newmoon";
      if (hasFull) cls += " fullmoon";
      cell.className = cls;

      const moon = document.createElement("span");
      moon.className = "moonmark";
      // æ–°æœˆ/æº€æœˆã®æ—¥ã¯ç¢ºå®Ÿã«ğŸŒ‘/ğŸŒ•
      moon.textContent = hasNew ? "ğŸŒ‘" : (hasFull ? "ğŸŒ•" : phase.mark);

      const num = document.createElement("span");
      num.textContent = String(day);

      cell.appendChild(moon);
      cell.appendChild(num);

      const w = weekdayIndex(info.y, idx0, day);
      const tags = [];
      if (hasNew) tags.push("æ–°æœˆ");
      if (hasFull) tags.push("æº€æœˆ");

      cell.title =
        `${info.y}å¹´ ${(info.isLeap && (idx0+1)===13) ? "é–13æœˆ" : (idx0+1+"æœˆ")} ${day}æ—¥ / ${DOW[w]}\n` +
        `æœˆé½¢ ${age.toFixed(3)}æ—¥ï¼ˆ${phase.name}ï¼‰` +
        (tags.length ? ` / ${tags.join("ãƒ»")}` : "");

      days.appendChild(cell);
    }

    // æœ€çµ‚è¡Œã®æ¬ ã‘ã‚’åŸ‹ã‚ã‚‹ï¼ˆ10åˆ—å˜ä½ï¼‰
    const totalCells = startW + daysInMonth;
    const pad = mod((WEEK_LEN - mod(totalCells, WEEK_LEN)), WEEK_LEN);
    for (let i=0; i<pad; i++){
      const e = document.createElement("div");
      e.className = "empty";
      e.textContent = ".";
      days.appendChild(e);
    }

    card.appendChild(days);
    return card;
  }

  function render(){
    const info = getYearInfo(yearEl.value);
    yearEl.value = String(info.y);

    syncMonthOptions();

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    const cycleNo = info.cycleIndex;
    statusEl.innerHTML = `
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <span class="pill">å¹´ ${info.y}</span>
        <!-- <span class="pill">å‘¨æœŸ ${cycleNo} / å‘¨æœŸå†… ${info.yearInCycle}å¹´ç›®</span> -->
        <span class="pill ${info.isLeap ? "warn" : ""}">${info.isLeap ? "é–å¹´" : "å¹³å¹´"}</span>
        <!-- <span class="pill">æœˆæ•° ${info.monthsCount}</span>
        <span class="pill">å¹´æ—¥æ•° ${info.yearDays}</span> -->
      </div>
    `;

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
    calEl.innerHTML = "";
    const grid = document.createElement("div");
    grid.className = "year-grid";

    if (viewEl.value === "month"){
      grid.style.gridTemplateColumns = "minmax(280px, 520px)";
      const m = Math.min(info.monthsCount, Math.max(1, Math.trunc(Number(monthEl.value || 1))));
      grid.appendChild(buildMonthCard(info.y, m));
      calEl.appendChild(grid);
      return;
    }

    for (let m=1; m<=info.monthsCount; m++){
      grid.appendChild(buildMonthCard(info.y, m));
    }
    calEl.appendChild(grid);
  }

  function sum(arr){ return arr.reduce((a,b)=>a+b,0); }

  // ã‚¤ãƒ™ãƒ³ãƒˆ
  document.getElementById("render").addEventListener("click", render);
  viewEl.addEventListener("change", () => { syncMonthOptions(); render(); });
  yearEl.addEventListener("keydown", (e) => { if (e.key === "Enter") render(); });
  monthEl.addEventListener("change", render);

  // åˆæœŸåŒ–
  syncMonthOptions();
  render();
</script>
</body>
</html>